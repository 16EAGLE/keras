<!DOCTYPE html>
<head>

<meta charset="utf-8">
<meta content='width=device-width' name='viewport'>

<link href="c3/c3.min.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="d3/d3.min.js"></script>
<script type="text/javascript" src="c3/c3.min.js"></script>

<style type="text/css">
#c3-container {
  height: 99vh;
} 

.c3 {
  width: 100%;
}

</style>

</head>

<body>

<div id="c3-container"></div>

<script type="text/javascript">

// utility function to load history
function load_history(callback) {
  var request = new XMLHttpRequest();
  request.onreadystatechange = function() {
  if (request.readyState === 4) {
    if (request.status === 200 || request.status === 0) {
      var data = JSON.parse(request.responseText);
      if (callback) 
        callback(data);
    }
  }
  };
  request.open('GET', "history.json");
  request.setRequestHeader('Cache-Control', 'no-cache');
  request.send(); 
}


// yield chart column data
function chart_columns(metric, data) {
  
  var columns = [
    [metric,null].concat(data.metrics[metric])
  ];
  
  if (data.params.do_validation[0]) {
    var val_metric = "val_" + metric;
    columns.push(
      [val_metric,null].concat(data.metrics[val_metric])
    );
  }
  
  return columns;
}

// resize charts to fit the window
function size_charts(c3_charts) {
  var c3_container = document.getElementById("c3-container");
  var chart_height = c3_container.offsetHeight / c3_charts.length;
  for (var i = 0; i<c3_charts.length; i++) {
    var chart = c3_charts[i];
    var element = chart.element;
    element.style.maxHeight = "none";
    element.style.height = chart_height + "px";
    var elementRect = element.getBoundingClientRect();
    chart.resize({
      height: elementRect.height,
      width: elementRect.width
    });
  }
    
}

// initialize charts
load_history(function(data) {
  
  // alias params and metrics
  var params = data.params;
  var metrics = data.metrics;
  
  // determine metrics we will be plotting
  var metric_names = [];
  for (var i = 0; i<params.metrics.length; i++) {
    var metric = params.metrics[i];
    if (metric.lastIndexOf("val_", 0) !== 0)
      metric_names.push(metric);
  }
  
  // get the container and determine the initial height of charts
  var c3_container = document.getElementById("c3-container");
  var chart_height = c3_container.offsetHeight / metric_names.length;
  
  // create a C3 chart for each metric
  var c3_charts = [];
  for (var i = 0; i<metric_names.length; i++) {
    
    // get the metric 
    var metric = metric_names[i];
    
    // create a chart wrapper div
    var c3_div = document.createElement("div");
    c3_container.appendChild(c3_div);
    
    // create c3 chart bound to div
    var epochs = data.params.epochs[0];
    var tick_values = [];
    for (var n = 1; n <= epochs; n++)
      tick_values.push(n);
    var chart = c3.generate({
      bindto: c3_div,
      axis: {
        x: {
          min: 1,
          max: tick_values.length,
          tick: {
            values: tick_values
          }
        }  
      },
      data: {
        columns: chart_columns(metric, data)
      },
      size: {
        height: chart_height
      }
    });
  
    // track chart
    c3_charts.push(chart);
  }
  
  // update all charts every second
  var updateInterval = setInterval(function() {
    load_history(function(data) {
      
      // refresh each metric
      for (var i = 0; i<metric_names.length; i++) {
        var metric = metric_names[i];
        var chart = c3_charts[i];
        chart.load({
          columns: chart_columns(metric, data)
        });
      }
      
      // stop refreshing when metrics when we have all epochs
      var first_metric = data.metrics[Object.keys(data.metrics)[0]];
      if (first_metric.length >= epochs)
        clearInterval(updateInterval);
    });
  }, 1000);
  
  // resize charts when window resizes
  window.addEventListener("resize", function(e) {
    var c3_container = document.getElementById("c3-container");
    var chart_height = c3_container.offsetHeight / c3_charts.length;
    for (var i = 0; i<c3_charts.length; i++) {
      var chart = c3_charts[i];
      var element = chart.element;
      element.style.maxHeight = "none";
      element.style.height = chart_height + "px";
      var elementRect = element.getBoundingClientRect();
      chart.resize({
        height: elementRect.height,
        width: elementRect.width
      });
    } 
  });
});

</script>
  

  
</body>



