<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Save, serialize, and export models • keras</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<script src="../../extra.js"></script><meta property="og:title" content="Save, serialize, and export models">
<meta property="og:description" content="Complete guide to saving, serializing, and exporting models.">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">keras</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.13.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="../../articles/tutorial_basic_classification.html">Basic Classification</a>
    </li>
    <li>
      <a href="../../articles/tutorial_basic_text_classification.html">Text Classification</a>
    </li>
    <li>
      <a href="../../articles/tutorial_basic_regression.html">Basic Regression</a>
    </li>
    <li>
      <a href="../../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    </li>
    <li>
      <a href="../../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Guides (New for TF 2.6)</li>
    <li>
      <a href="../../articles/new-guides/python_subclasses.html">Python Subclasses</a>
    </li>
    <li>
      <a href="../../articles/new-guides/making_new_layers_and_models_via_subclassing.html">Making New Layers and Models via Subclassing</a>
    </li>
    <li>
      <a href="../../articles/new-guides/customizing_what_happens_in_fit.html">Customizing What Happens in Fit</a>
    </li>
    <li>
      <a href="../../articles/new-guides/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    </li>
    <li>
      <a href="../../articles/new-guides/preprocessing_layers.html">Working with Preprocessing Layers</a>
    </li>
    <li>
      <a href="../../argicles/new-guides/working_with_rnns.html">Working with RNNs</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Using Keras</li>
    <li>
      <a href="../../articles/guide_keras.html">Guide to Keras Basics</a>
    </li>
    <li>
      <a href="../../articles/sequential_model.html">Sequential Model in Depth</a>
    </li>
    <li>
      <a href="../../articles/functional_api.html">Functional API in Depth</a>
    </li>
    <li>
      <a href="../../articles/about_keras_models.html">About Keras Models</a>
    </li>
    <li>
      <a href="../../articles/about_keras_layers.html">About Keras Layers</a>
    </li>
    <li>
      <a href="../../articles/training_visualization.html">Training Visualization</a>
    </li>
    <li>
      <a href="../../articles/applications.html">Pre-Trained Models</a>
    </li>
    <li>
      <a href="../../articles/faq.html">Frequently Asked Questions</a>
    </li>
    <li>
      <a href="../../articles/why_use_keras.html">Why Use Keras?</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Advanced</li>
    <li>
      <a href="../../articles/eager_guide.html">Eager Execution</a>
    </li>
    <li>
      <a href="../../articles/training_callbacks.html">Training Callbacks</a>
    </li>
    <li>
      <a href="../../articles/backend.html">Keras Backend</a>
    </li>
    <li>
      <a href="../../articles/custom_layers.html">Custom Layers</a>
    </li>
    <li>
      <a href="../../articles/custom_models.html">Custom Models</a>
    </li>
    <li>
      <a href="../../articles/saving_serializing.html">Saving and serializing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../articles/learn.html">Learn</a>
</li>
<li>
  <a href="../../articles/tools.html">Tools</a>
</li>
<li>
  <a href="../../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/keras/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Save, serialize, and export models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/HEAD/vignettes/guides/serialization_and_saving.Rmd" class="external-link"><code>vignettes/guides/serialization_and_saving.Rmd</code></a></small>
      <div class="hidden name"><code>serialization_and_saving.Rmd</code></div>

    </div>

    
    
<p><strong>Note: this guide assumes Keras &gt;= 2.13</strong></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>A Keras model consists of multiple components:</p>
<ul>
<li>The architecture, or configuration, which specifies what layers the
model contain, and how they’re connected.</li>
<li>A set of weights values (the “state of the model”).</li>
<li>An optimizer (defined by compiling the model).</li>
<li>A set of losses and metrics (defined by compiling the model).</li>
</ul>
<p>The Keras API saves all of these pieces together in a unified format,
marked by the <code>.keras</code> extension. This is a zip archive
consisting of the following:</p>
<ul>
<li>A JSON-based configuration file (config.json): Records of model,
layer, and other trackables’ configuration.</li>
<li>A H5-based state file, such as <code>model.weights.h5</code> (for
the whole model), with directory keys for layers and their weights.</li>
<li>A metadata file in JSON, storing things such as the current Keras
version.</li>
</ul>
<p>Let’s take a look at how this works.</p>
</div>
<div class="section level2">
<h2 id="how-to-save-and-load-a-model">How to save and load a model<a class="anchor" aria-label="anchor" href="#how-to-save-and-load-a-model"></a>
</h2>
<p>If you only have 10 seconds to read this guide, here’s what you need
to know.</p>
<p><strong>Saving a Keras model:</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>model <span class="op">=</span> ...  <span class="co"># Get model (Sequential, Functional Model, or Model subclass)</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>model.save(<span class="st">'path/to/location.keras'</span>)  <span class="co"># The file needs to end with the .keras extension</span></span></code></pre></div>
<p><strong>Loading the model back:</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>model <span class="op">=</span> keras.models.load_model(<span class="st">'path/to/location.keras'</span>)</span></code></pre></div>
<p>Now, let’s look at the details.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="im">import</span> keras_core <span class="im">as</span> keras</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="im">from</span> keras_core <span class="im">import</span> ops</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="saving">Saving<a class="anchor" aria-label="anchor" href="#saving"></a>
</h2>
<p>This section is about saving an entire model to a single file. The
file will include:</p>
<ul>
<li>The model’s architecture/config</li>
<li>The model’s weight values (which were learned during training)</li>
<li>The model’s compilation information (if <code><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile()</a></code> was
called)</li>
<li>The optimizer and its state, if any (this enables you to restart
training where you left)</li>
</ul>
<div class="section level4">
<h4 id="apis">APIs<a class="anchor" aria-label="anchor" href="#apis"></a>
</h4>
<p>You can save a model with <code>model.save()</code> or
<code>keras.models.save_model()</code> (which is equivalent). You can
load it back with <code>keras.models.load_model()</code>.</p>
<p>The only supported format in Keras Core is the “Keras v3” format,
which uses the <code>.keras</code> extension.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">def</span> get_model():</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    <span class="co"># Create a simple model.</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    inputs <span class="op">=</span> keras.Input(shape<span class="op">=</span>(<span class="dv">32</span>,))</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    outputs <span class="op">=</span> keras.layers.Dense(<span class="dv">1</span>)(inputs)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    model <span class="op">=</span> keras.Model(inputs, outputs)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    model.<span class="bu">compile</span>(optimizer<span class="op">=</span>keras.optimizers.Adam(), loss<span class="op">=</span><span class="st">"mean_squared_error"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>model <span class="op">=</span> get_model()</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="co"># Train the model.</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>test_input <span class="op">=</span> np.random.random((<span class="dv">128</span>, <span class="dv">32</span>))</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>test_target <span class="op">=</span> np.random.random((<span class="dv">128</span>, <span class="dv">1</span>))</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>model.fit(test_input, test_target)</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="co"># Calling `save('my_model.keras')` creates a zip archive `my_model.keras`.</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>model.save(<span class="st">"my_model.keras"</span>)</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="co"># It can be used to reconstruct the model identically.</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>reconstructed_model <span class="op">=</span> keras.models.load_model(<span class="st">"my_model.keras"</span>)</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="co"># Let's check:</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>np.testing.assert_allclose(</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>    model.predict(test_input), reconstructed_model.predict(test_input)</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-objects">Custom objects<a class="anchor" aria-label="anchor" href="#custom-objects"></a>
</h3>
<p>This section covers the basic workflows for handling custom layers,
functions, and models in Keras saving and reloading.</p>
<p>When saving a model that includes custom objects, such as a
subclassed Layer, you <strong>must</strong> define a
<code><a href="../../reference/get_config.html">get_config()</a></code> method on the object class. If the arguments
passed to the constructor (<code>__init__()</code> method) of the custom
object aren’t Python objects (anything other than base types like ints,
strings, etc.), then you <strong>must</strong> also explicitly
deserialize these arguments in the <code><a href="../../reference/get_config.html">from_config()</a></code> class
method.</p>
<p>Like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">class</span> CustomLayer(keras.layers.Layer):</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, sublayer, <span class="op">**</span>kwargs):</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>        <span class="va">self</span>.sublayer <span class="op">=</span> layer</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, x):</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.sublayer(x)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>        base_config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>        config <span class="op">=</span> {</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>            <span class="st">"sublayer"</span>: keras.saving.serialize_keras_object(<span class="va">self</span>.sublayer),</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>        }</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>        <span class="cf">return</span> {<span class="op">**</span>base_config, <span class="op">**</span>config}</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    <span class="kw">def</span> from_config(cls, config):</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>        sublayer_config <span class="op">=</span> config.pop(<span class="st">"sublayer"</span>)</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>        sublayer <span class="op">=</span> keras.saving.deserialize_keras_object(sublayer_config)</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>        <span class="cf">return</span> cls(sublayer, <span class="op">**</span>config)</span></code></pre></div>
<p>Please see the <a href="#config_methods">Defining the config methods
section</a> for more details and examples.</p>
<p>The saved <code>.keras</code> file is lightweight and does not store
the Python code for custom objects. Therefore, to reload the model,
<code>load_model</code> requires access to the definition of any custom
objects used through one of the following methods:</p>
<ol style="list-style-type: decimal">
<li>Registering custom objects <strong>(preferred)</strong>,</li>
<li>Passing custom objects directly when loading, or</li>
<li>Using a custom object scope</li>
</ol>
<p>Below are examples of each workflow:</p>
<div class="section level4">
<h4 id="registering-custom-objects-preferred">Registering custom objects (<strong>preferred</strong>)<a class="anchor" aria-label="anchor" href="#registering-custom-objects-preferred"></a>
</h4>
<p>This is the preferred method, as custom object registration greatly
simplifies saving and loading code. Adding the
<code>@keras.saving.register_keras_serializable</code> decorator to the
class definition of a custom object registers the object globally in a
master list, allowing Keras to recognize the object when loading the
model.</p>
<p>Let’s create a custom model involving both a custom layer and a
custom activation function to demonstrate this.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Clear all previously registered custom objects</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>keras.saving.get_custom_objects().clear()</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co"># Upon registration, you can optionally specify a package or a name.</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co"># If left blank, the package defaults to `Custom` and the name defaults to</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co"># the class name.</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="at">@keras.saving.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"MyLayers"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="kw">class</span> CustomLayer(keras.layers.Layer):</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, factor):</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>        <span class="va">self</span>.factor <span class="op">=</span> factor</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, x):</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>        <span class="cf">return</span> x <span class="op">*</span> <span class="va">self</span>.factor</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"factor"</span>: <span class="va">self</span>.factor}</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="at">@keras.saving.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"my_package"</span>, name<span class="op">=</span><span class="st">"custom_fn"</span>)</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="kw">def</span> custom_fn(x):</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">**</span><span class="dv">2</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a><span class="co"># Create the model.</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a><span class="kw">def</span> get_model():</span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>    inputs <span class="op">=</span> keras.Input(shape<span class="op">=</span>(<span class="dv">4</span>,))</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>    mid <span class="op">=</span> CustomLayer(<span class="fl">0.5</span>)(inputs)</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>    outputs <span class="op">=</span> keras.layers.Dense(<span class="dv">1</span>, activation<span class="op">=</span>custom_fn)(mid)</span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>    model <span class="op">=</span> keras.Model(inputs, outputs)</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>    model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">"rmsprop"</span>, loss<span class="op">=</span><span class="st">"mean_squared_error"</span>)</span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a><span class="co"># Train the model.</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a><span class="kw">def</span> train_model(model):</span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>    <span class="bu">input</span> <span class="op">=</span> np.random.random((<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>    target <span class="op">=</span> np.random.random((<span class="dv">4</span>, <span class="dv">1</span>))</span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>    model.fit(<span class="bu">input</span>, target)</span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a>test_input <span class="op">=</span> np.random.random((<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a>test_target <span class="op">=</span> np.random.random((<span class="dv">4</span>, <span class="dv">1</span>))</span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>model <span class="op">=</span> get_model()</span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a>model <span class="op">=</span> train_model(model)</span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>model.save(<span class="st">"custom_model.keras"</span>)</span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a><span class="co"># Now, we can simply load without worrying about our custom objects.</span></span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>reconstructed_model <span class="op">=</span> keras.models.load_model(<span class="st">"custom_model.keras"</span>)</span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a><span class="co"># Let's check:</span></span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a>np.testing.assert_allclose(</span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a>    model.predict(test_input), reconstructed_model.predict(test_input)</span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="passing-custom-objects-to-load_model">Passing custom objects to <code>load_model()</code><a class="anchor" aria-label="anchor" href="#passing-custom-objects-to-load_model"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>model <span class="op">=</span> get_model()</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>model <span class="op">=</span> train_model(model)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co"># Calling `save('my_model.keras')` creates a zip archive `my_model.keras`.</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>model.save(<span class="st">"custom_model.keras"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co"># Upon loading, pass a dict containing the custom objects used in the</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co"># `custom_objects` argument of `keras.models.load_model()`.</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>reconstructed_model <span class="op">=</span> keras.models.load_model(</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    <span class="st">"custom_model.keras"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>    custom_objects<span class="op">=</span>{<span class="st">"CustomLayer"</span>: CustomLayer, <span class="st">"custom_fn"</span>: custom_fn},</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>)</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="co"># Let's check:</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>np.testing.assert_allclose(</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>    model.predict(test_input), reconstructed_model.predict(test_input)</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="using-a-custom-object-scope">Using a custom object scope<a class="anchor" aria-label="anchor" href="#using-a-custom-object-scope"></a>
</h4>
<p>Any code within the custom object scope will be able to recognize the
custom objects passed to the scope argument. Therefore, loading the
model within the scope will allow the loading of our custom objects.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>model <span class="op">=</span> get_model()</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>model <span class="op">=</span> train_model(model)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>model.save(<span class="st">"custom_model.keras"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co"># Pass the custom objects dictionary to a custom object scope and place</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co"># the `keras.models.load_model()` call within the scope.</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>custom_objects <span class="op">=</span> {<span class="st">"CustomLayer"</span>: CustomLayer, <span class="st">"custom_fn"</span>: custom_fn}</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="cf">with</span> keras.saving.custom_object_scope(custom_objects):</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    reconstructed_model <span class="op">=</span> keras.models.load_model(<span class="st">"custom_model.keras"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="co"># Let's check:</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>np.testing.assert_allclose(</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>    model.predict(test_input), reconstructed_model.predict(test_input)</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="model-serialization">Model serialization<a class="anchor" aria-label="anchor" href="#model-serialization"></a>
</h3>
<p>This section is about saving only the model’s configuration, without
its state. The model’s configuration (or architecture) specifies what
layers the model contains, and how these layers are connected. If you
have the configuration of a model, then the model can be created with a
freshly initialized state (no weights or compilation information).</p>
<div class="section level4">
<h4 id="apis-1">APIs<a class="anchor" aria-label="anchor" href="#apis-1"></a>
</h4>
<p>The following serialization APIs are available:</p>
<ul>
<li>
<code>keras.models.clone_model(model)</code>: make a (randomly
initialized) copy of a model.</li>
<li>
<code><a href="../../reference/get_config.html">get_config()</a></code> and <code>cls.from_config()</code>:
retrieve the configuration of a layer or model, and recreate a model
instance from its config, respectively.</li>
<li>
<code>keras.models.model_to_json()</code> and
<code>keras.models.model_from_json()</code>: similar, but as JSON
strings.</li>
<li>
<code>keras.saving.serialize_keras_object()</code>: retrieve the
configuration any arbitrary Keras object.</li>
<li>
<code>keras.saving.deserialize_keras_object()</code>: recreate an
object instance from its configuration.</li>
</ul>
</div>
<div class="section level4">
<h4 id="in-memory-model-cloning">In-memory model cloning<a class="anchor" aria-label="anchor" href="#in-memory-model-cloning"></a>
</h4>
<p>You can do in-memory cloning of a model via
<code>keras.models.clone_model()</code>. This is equivalent to getting
the config then recreating the model from its config (so it does not
preserve compilation information or layer weights values).</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>new_model <span class="op">=</span> keras.models.clone_model(model)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="get_config-and-from_config">
<code>get_config()</code> and <code>from_config()</code><a class="anchor" aria-label="anchor" href="#get_config-and-from_config"></a>
</h4>
<p>Calling <code>model.get_config()</code> or
<code>layer.get_config()</code> will return a Python dict containing the
configuration of the model or layer, respectively. You should define
<code><a href="../../reference/get_config.html">get_config()</a></code> to contain arguments needed for the
<code>__init__()</code> method of the model or layer. At loading time,
the <code>from_config(config)</code> method will then call
<code>__init__()</code> with these arguments to reconstruct the model or
layer.</p>
<p><strong>Layer example:</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>layer <span class="op">=</span> keras.layers.Dense(<span class="dv">3</span>, activation<span class="op">=</span><span class="st">"relu"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>layer_config <span class="op">=</span> layer.get_config()</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="bu">print</span>(layer_config)</span></code></pre></div>
<p>Now let’s reconstruct the layer using the <code><a href="../../reference/get_config.html">from_config()</a></code>
method:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>new_layer <span class="op">=</span> keras.layers.Dense.from_config(layer_config)</span></code></pre></div>
<p><strong>Sequential model example:</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>model <span class="op">=</span> keras.Sequential([keras.Input((<span class="dv">32</span>,)), keras.layers.Dense(<span class="dv">1</span>)])</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>config <span class="op">=</span> model.get_config()</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>new_model <span class="op">=</span> keras.Sequential.from_config(config)</span></code></pre></div>
<p><strong>Functional model example:</strong></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>inputs <span class="op">=</span> keras.Input((<span class="dv">32</span>,))</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>outputs <span class="op">=</span> keras.layers.Dense(<span class="dv">1</span>)(inputs)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>model <span class="op">=</span> keras.Model(inputs, outputs)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>config <span class="op">=</span> model.get_config()</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>new_model <span class="op">=</span> keras.Model.from_config(config)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="to_json-and-keras-models-model_from_json">
<code>to_json()</code> and
<code>keras.models.model_from_json()</code><a class="anchor" aria-label="anchor" href="#to_json-and-keras-models-model_from_json"></a>
</h4>
<p>This is similar to <code>get_config</code> /
<code>from_config</code>, except it turns the model into a JSON string,
which can then be loaded without the original model class. It is also
specific to models, it isn’t meant for layers.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>model <span class="op">=</span> keras.Sequential([keras.Input((<span class="dv">32</span>,)), keras.layers.Dense(<span class="dv">1</span>)])</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>json_config <span class="op">=</span> model.to_json()</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>new_model <span class="op">=</span> keras.models.model_from_json(json_config)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="arbitrary-object-serialization-and-deserialization">Arbitrary object serialization and deserialization<a class="anchor" aria-label="anchor" href="#arbitrary-object-serialization-and-deserialization"></a>
</h4>
<p>The <code>keras.saving.serialize_keras_object()</code> and
<code>keras.saving.deserialize_keras_object()</code> APIs are
general-purpose APIs that can be used to serialize or deserialize any
Keras object and any custom object. It is at the foundation of saving
model architecture and is behind all
<code><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize()</a></code>/<code>deserialize()</code> calls in keras.</p>
<p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>my_reg <span class="op">=</span> keras.regularizers.L1(<span class="fl">0.005</span>)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>config <span class="op">=</span> keras.saving.serialize_keras_object(my_reg)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="bu">print</span>(config)</span></code></pre></div>
<p>Note the serialization format containing all the necessary
information for proper reconstruction:</p>
<ul>
<li>
<code>module</code> containing the name of the Keras module or other
identifying module the object comes from</li>
<li>
<code>class_name</code> containing the name of the object’s
class.</li>
<li>
<code>config</code> with all the information needed to reconstruct
the object</li>
<li>
<code>registered_name</code> for custom objects. See <a href="#custom_object_serialization">here</a>.</li>
</ul>
<p>Now we can reconstruct the regularizer.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>new_reg <span class="op">=</span> keras.saving.deserialize_keras_object(config)</span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="model-weights-saving">Model weights saving<a class="anchor" aria-label="anchor" href="#model-weights-saving"></a>
</h3>
<p>You can choose to only save &amp; load a model’s weights. This can be
useful if:</p>
<ul>
<li>You only need the model for inference: in this case you won’t need
to restart training, so you don’t need the compilation information or
optimizer state.</li>
<li>You are doing transfer learning: in this case you will be training a
new model reusing the state of a prior model, so you don’t need the
compilation information of the prior model.</li>
</ul>
<div class="section level4">
<h4 id="apis-for-in-memory-weight-transfer">APIs for in-memory weight transfer<a class="anchor" aria-label="anchor" href="#apis-for-in-memory-weight-transfer"></a>
</h4>
<p>Weights can be copied between different objects by using
<code><a href="../../reference/get_weights.html">get_weights()</a></code> and <code><a href="../../reference/get_weights.html">set_weights()</a></code>:</p>
<ul>
<li>
<code>keras.layers.Layer.get_weights()</code>: Returns a list of
NumPy arrays of weight values.</li>
<li>
<code>keras.layers.Layer.set_weights(weights)</code>: Sets the model
weights to the values provided (as NumPy arrays).</li>
</ul>
<p>Examples:</p>
<p><strong><em>Transfering weights from one layer to another, in
memory</em></strong></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="kw">def</span> create_layer():</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    layer <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_2"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>    layer.build((<span class="va">None</span>, <span class="dv">784</span>))</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    <span class="cf">return</span> layer</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>layer_1 <span class="op">=</span> create_layer()</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>layer_2 <span class="op">=</span> create_layer()</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="co"># Copy weights from layer 1 to layer 2</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>layer_2.set_weights(layer_1.get_weights())</span></code></pre></div>
<p><strong><em>Transfering weights from one model to another model with
a compatible architecture, in memory</em></strong></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># Create a simple functional model</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>inputs <span class="op">=</span> keras.Input(shape<span class="op">=</span>(<span class="dv">784</span>,), name<span class="op">=</span><span class="st">"digits"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_1"</span>)(inputs)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_2"</span>)(x)</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>outputs <span class="op">=</span> keras.layers.Dense(<span class="dv">10</span>, name<span class="op">=</span><span class="st">"predictions"</span>)(x)</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>functional_model <span class="op">=</span> keras.Model(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, name<span class="op">=</span><span class="st">"3_layer_mlp"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co"># Define a subclassed model with the same architecture</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="kw">class</span> SubclassedModel(keras.Model):</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, output_dim, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(name<span class="op">=</span>name)</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>        <span class="va">self</span>.output_dim <span class="op">=</span> output_dim</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>        <span class="va">self</span>.dense_1 <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_1"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>        <span class="va">self</span>.dense_2 <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_2"</span>)</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>        <span class="va">self</span>.dense_3 <span class="op">=</span> keras.layers.Dense(output_dim, name<span class="op">=</span><span class="st">"predictions"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dense_1(inputs)</span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dense_2(x)</span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dense_3(x)</span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"output_dim"</span>: <span class="va">self</span>.output_dim, <span class="st">"name"</span>: <span class="va">self</span>.name}</span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a>subclassed_model <span class="op">=</span> SubclassedModel(<span class="dv">10</span>)</span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a><span class="co"># Call the subclassed model once to create the weights.</span></span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a>subclassed_model(np.ones((<span class="dv">1</span>, <span class="dv">784</span>)))</span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a><span class="co"># Copy weights from functional_model to subclassed_model.</span></span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a>subclassed_model.set_weights(functional_model.get_weights())</span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(functional_model.weights) <span class="op">==</span> <span class="bu">len</span>(subclassed_model.weights)</span>
<span id="cb18-36"><a href="#cb18-36" tabindex="-1"></a><span class="cf">for</span> a, b <span class="kw">in</span> <span class="bu">zip</span>(functional_model.weights, subclassed_model.weights):</span>
<span id="cb18-37"><a href="#cb18-37" tabindex="-1"></a>    np.testing.assert_allclose(a.numpy(), b.numpy())</span></code></pre></div>
<p><strong><em>The case of stateless layers</em></strong></p>
<p>Because stateless layers do not change the order or number of
weights, models can have compatible architectures even if there are
extra/missing stateless layers.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>inputs <span class="op">=</span> keras.Input(shape<span class="op">=</span>(<span class="dv">784</span>,), name<span class="op">=</span><span class="st">"digits"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_1"</span>)(inputs)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_2"</span>)(x)</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>outputs <span class="op">=</span> keras.layers.Dense(<span class="dv">10</span>, name<span class="op">=</span><span class="st">"predictions"</span>)(x)</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>functional_model <span class="op">=</span> keras.Model(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, name<span class="op">=</span><span class="st">"3_layer_mlp"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>inputs <span class="op">=</span> keras.Input(shape<span class="op">=</span>(<span class="dv">784</span>,), name<span class="op">=</span><span class="st">"digits"</span>)</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_1"</span>)(inputs)</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_2"</span>)(x)</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="co"># Add a dropout layer, which does not contain any weights.</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.5</span>)(x)</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>outputs <span class="op">=</span> keras.layers.Dense(<span class="dv">10</span>, name<span class="op">=</span><span class="st">"predictions"</span>)(x)</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>functional_model_with_dropout <span class="op">=</span> keras.Model(</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>    inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, name<span class="op">=</span><span class="st">"3_layer_mlp"</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>)</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>functional_model_with_dropout.set_weights(functional_model.get_weights())</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="apis-for-saving-weights-to-disk-loading-them-back">APIs for saving weights to disk &amp; loading them back<a class="anchor" aria-label="anchor" href="#apis-for-saving-weights-to-disk-loading-them-back"></a>
</h4>
<p>Weights can be saved to disk by calling
<code>model.save_weights(filepath)</code>. The filename should end in
<code>.weights.h5</code>.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># Runnable example</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>sequential_model <span class="op">=</span> keras.Sequential(</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>    [</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>        keras.Input(shape<span class="op">=</span>(<span class="dv">784</span>,), name<span class="op">=</span><span class="st">"digits"</span>),</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>        keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_1"</span>),</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>        keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_2"</span>),</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>        keras.layers.Dense(<span class="dv">10</span>, name<span class="op">=</span><span class="st">"predictions"</span>),</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>    ]</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>)</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>sequential_model.save_weights(<span class="st">"my_model.weights.h5"</span>)</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>sequential_model.load_weights(<span class="st">"my_model.weights.h5"</span>)</span></code></pre></div>
<p>Note that changing <code>layer.trainable</code> may result in a
different <code>layer.weights</code> ordering when the model contains
nested layers.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="kw">class</span> NestedDenseLayer(keras.layers.Layer):</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, units, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(name<span class="op">=</span>name)</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>        <span class="va">self</span>.dense_1 <span class="op">=</span> keras.layers.Dense(units, name<span class="op">=</span><span class="st">"dense_1"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>        <span class="va">self</span>.dense_2 <span class="op">=</span> keras.layers.Dense(units, name<span class="op">=</span><span class="st">"dense_2"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.dense_2(<span class="va">self</span>.dense_1(inputs))</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>nested_model <span class="op">=</span> keras.Sequential([keras.Input((<span class="dv">784</span>,)), NestedDenseLayer(<span class="dv">10</span>, <span class="st">"nested"</span>)])</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>variable_names <span class="op">=</span> [v.name <span class="cf">for</span> v <span class="kw">in</span> nested_model.weights]</span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"variables: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(variable_names))</span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Changing trainable status of one of the nested layers..."</span>)</span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>nested_model.get_layer(<span class="st">"nested"</span>).dense_1.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a>variable_names_2 <span class="op">=</span> [v.name <span class="cf">for</span> v <span class="kw">in</span> nested_model.weights]</span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">variables: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(variable_names_2))</span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"variable ordering changed:"</span>, variable_names <span class="op">!=</span> variable_names_2)</span></code></pre></div>
<div class="section level5">
<h5 id="transfer-learning-example">
<strong>Transfer learning example</strong><a class="anchor" aria-label="anchor" href="#transfer-learning-example"></a>
</h5>
<p>When loading pretrained weights from a weights file, it is
recommended to load the weights into the original checkpointed model,
and then extract the desired weights/layers into a new model.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="kw">def</span> create_functional_model():</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>    inputs <span class="op">=</span> keras.Input(shape<span class="op">=</span>(<span class="dv">784</span>,), name<span class="op">=</span><span class="st">"digits"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_1"</span>)(inputs)</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"relu"</span>, name<span class="op">=</span><span class="st">"dense_2"</span>)(x)</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>    outputs <span class="op">=</span> keras.layers.Dense(<span class="dv">10</span>, name<span class="op">=</span><span class="st">"predictions"</span>)(x)</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>    <span class="cf">return</span> keras.Model(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, name<span class="op">=</span><span class="st">"3_layer_mlp"</span>)</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>functional_model <span class="op">=</span> create_functional_model()</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>functional_model.save_weights(<span class="st">"pretrained.weights.h5"</span>)</span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="co"># In a separate program:</span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>pretrained_model <span class="op">=</span> create_functional_model()</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>pretrained_model.load_weights(<span class="st">"pretrained.weights.h5"</span>)</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a><span class="co"># Create a new model by extracting layers from the original model:</span></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>extracted_layers <span class="op">=</span> pretrained_model.layers[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>extracted_layers.append(keras.layers.Dense(<span class="dv">5</span>, name<span class="op">=</span><span class="st">"dense_3"</span>))</span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a>model <span class="op">=</span> keras.Sequential(extracted_layers)</span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>model.summary()</span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="appendix-handling-custom-objects">Appendix: Handling custom objects<a class="anchor" aria-label="anchor" href="#appendix-handling-custom-objects"></a>
</h3>
<p><a name="config_methods"></a> #### Defining the config methods</p>
<p>Specifications:</p>
<ul>
<li>
<code><a href="../../reference/get_config.html">get_config()</a></code> should return a JSON-serializable
dictionary in order to be compatible with the Keras architecture- and
model-saving APIs.</li>
<li>
<code>from_config(config)</code> (a <code>classmethod</code>) should
return a new layer or model object that is created from the config. The
default implementation returns <code>cls(**config)</code>.</li>
</ul>
<p><strong>NOTE</strong>: If all your constructor arguments are already
serializable, e.g. strings and ints, or non-custom Keras objects,
overriding <code>from_config</code> is not necessary. However, for more
complex objects such as layers or models passed to
<code>__init__</code>, deserialization must be handled explicitly either
in <code>__init__</code> itself or overriding the
<code><a href="../../reference/get_config.html">from_config()</a></code> method.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="at">@keras.saving.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"MyLayers"</span>, name<span class="op">=</span><span class="st">"KernelMult"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="kw">class</span> MyDense(keras.layers.Layer):</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>        units,</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>        <span class="op">*</span>,</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>        kernel_regularizer<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>        kernel_initializer<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>        nested_model<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>        <span class="op">**</span>kwargs</span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>    ):</span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>        <span class="va">self</span>.hidden_units <span class="op">=</span> units</span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>        <span class="va">self</span>.kernel_regularizer <span class="op">=</span> kernel_regularizer</span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a>        <span class="va">self</span>.kernel_initializer <span class="op">=</span> kernel_initializer</span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a>        <span class="va">self</span>.nested_model <span class="op">=</span> nested_model</span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a>        config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a>        <span class="co"># Update the config with the custom layer's parameters</span></span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a>        config.update(</span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a>            {</span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a>                <span class="st">"units"</span>: <span class="va">self</span>.hidden_units,</span>
<span id="cb23-24"><a href="#cb23-24" tabindex="-1"></a>                <span class="st">"kernel_regularizer"</span>: <span class="va">self</span>.kernel_regularizer,</span>
<span id="cb23-25"><a href="#cb23-25" tabindex="-1"></a>                <span class="st">"kernel_initializer"</span>: <span class="va">self</span>.kernel_initializer,</span>
<span id="cb23-26"><a href="#cb23-26" tabindex="-1"></a>                <span class="st">"nested_model"</span>: <span class="va">self</span>.nested_model,</span>
<span id="cb23-27"><a href="#cb23-27" tabindex="-1"></a>            }</span>
<span id="cb23-28"><a href="#cb23-28" tabindex="-1"></a>        )</span>
<span id="cb23-29"><a href="#cb23-29" tabindex="-1"></a>        <span class="cf">return</span> config</span>
<span id="cb23-30"><a href="#cb23-30" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" tabindex="-1"></a>    <span class="kw">def</span> build(<span class="va">self</span>, input_shape):</span>
<span id="cb23-32"><a href="#cb23-32" tabindex="-1"></a>        input_units <span class="op">=</span> input_shape[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb23-33"><a href="#cb23-33" tabindex="-1"></a>        <span class="va">self</span>.kernel <span class="op">=</span> <span class="va">self</span>.add_weight(</span>
<span id="cb23-34"><a href="#cb23-34" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"kernel"</span>,</span>
<span id="cb23-35"><a href="#cb23-35" tabindex="-1"></a>            shape<span class="op">=</span>(input_units, <span class="va">self</span>.hidden_units),</span>
<span id="cb23-36"><a href="#cb23-36" tabindex="-1"></a>            regularizer<span class="op">=</span><span class="va">self</span>.kernel_regularizer,</span>
<span id="cb23-37"><a href="#cb23-37" tabindex="-1"></a>            initializer<span class="op">=</span><span class="va">self</span>.kernel_initializer,</span>
<span id="cb23-38"><a href="#cb23-38" tabindex="-1"></a>        )</span>
<span id="cb23-39"><a href="#cb23-39" tabindex="-1"></a></span>
<span id="cb23-40"><a href="#cb23-40" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb23-41"><a href="#cb23-41" tabindex="-1"></a>        <span class="cf">return</span> ops.matmul(inputs, <span class="va">self</span>.kernel)</span>
<span id="cb23-42"><a href="#cb23-42" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" tabindex="-1"></a></span>
<span id="cb23-44"><a href="#cb23-44" tabindex="-1"></a>layer <span class="op">=</span> MyDense(units<span class="op">=</span><span class="dv">16</span>, kernel_regularizer<span class="op">=</span><span class="st">"l1"</span>, kernel_initializer<span class="op">=</span><span class="st">"ones"</span>)</span>
<span id="cb23-45"><a href="#cb23-45" tabindex="-1"></a>layer3 <span class="op">=</span> MyDense(units<span class="op">=</span><span class="dv">64</span>, nested_model<span class="op">=</span>layer)</span>
<span id="cb23-46"><a href="#cb23-46" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" tabindex="-1"></a>config <span class="op">=</span> keras.layers.serialize(layer3)</span>
<span id="cb23-48"><a href="#cb23-48" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" tabindex="-1"></a><span class="bu">print</span>(config)</span>
<span id="cb23-50"><a href="#cb23-50" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" tabindex="-1"></a>new_layer <span class="op">=</span> keras.layers.deserialize(config)</span>
<span id="cb23-52"><a href="#cb23-52" tabindex="-1"></a></span>
<span id="cb23-53"><a href="#cb23-53" tabindex="-1"></a><span class="bu">print</span>(new_layer)</span></code></pre></div>
<p>Note that overriding <code>from_config</code> is unnecessary above
for <code>MyDense</code> because <code>hidden_units</code>,
<code>kernel_initializer</code>, and <code>kernel_regularizer</code> are
ints, strings, and a built-in Keras object, respectively. This means
that the default <code>from_config</code> implementation of
<code>cls(**config)</code> will work as intended.</p>
<p>For more complex objects, such as layers and models passed to
<code>__init__</code>, for example, you must explicitly deserialize
these objects. Let’s take a look at an example of a model where a
<code>from_config</code> override is necessary.</p>
<p><strong>Example:</strong> <a name="registration_example"></a></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="at">@keras.saving.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"ComplexModels"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="kw">class</span> CustomModel(keras.layers.Layer):</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, first_layer, second_layer<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>        <span class="va">self</span>.first_layer <span class="op">=</span> first_layer</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>        <span class="cf">if</span> second_layer <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>            <span class="va">self</span>.second_layer <span class="op">=</span> second_layer</span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>            <span class="va">self</span>.second_layer <span class="op">=</span> keras.layers.Dense(<span class="dv">8</span>)</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>        config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>        config.update(</span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>            {</span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>                <span class="st">"first_layer"</span>: <span class="va">self</span>.first_layer,</span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>                <span class="st">"second_layer"</span>: <span class="va">self</span>.second_layer,</span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>            }</span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>        )</span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a>        <span class="cf">return</span> config</span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a>    <span class="kw">def</span> from_config(cls, config):</span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>        <span class="co"># Note that you can also use `keras.saving.deserialize_keras_object` here</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a>        config[<span class="st">"first_layer"</span>] <span class="op">=</span> keras.layers.deserialize(config[<span class="st">"first_layer"</span>])</span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a>        config[<span class="st">"second_layer"</span>] <span class="op">=</span> keras.layers.deserialize(config[<span class="st">"second_layer"</span>])</span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a>        <span class="cf">return</span> cls(<span class="op">**</span>config)</span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.first_layer(<span class="va">self</span>.second_layer(inputs))</span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a></span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a><span class="co"># Let's make our first layer the custom layer from the previous example (MyDense)</span></span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a>inputs <span class="op">=</span> keras.Input((<span class="dv">32</span>,))</span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a>outputs <span class="op">=</span> CustomModel(first_layer<span class="op">=</span>layer)(inputs)</span>
<span id="cb24-35"><a href="#cb24-35" tabindex="-1"></a>model <span class="op">=</span> keras.Model(inputs, outputs)</span>
<span id="cb24-36"><a href="#cb24-36" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" tabindex="-1"></a>config <span class="op">=</span> model.get_config()</span>
<span id="cb24-38"><a href="#cb24-38" tabindex="-1"></a>new_model <span class="op">=</span> keras.Model.from_config(config)</span></code></pre></div>
<p><a name="custom_object_serialization"></a> #### How custom objects
are serialized</p>
<p>The serialization format has a special key for custom objects
registered via <code>@keras.saving.register_keras_serializable</code>.
This <code>registered_name</code> key allows for easy retrieval at
loading/deserialization time while also allowing users to add custom
naming.</p>
<p>Let’s take a look at the config from serializing the custom layer
<code>MyDense</code> we defined above.</p>
<p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>layer <span class="op">=</span> MyDense(</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>    units<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>    kernel_regularizer<span class="op">=</span>keras.regularizers.L1L2(l1<span class="op">=</span><span class="fl">1e-5</span>, l2<span class="op">=</span><span class="fl">1e-4</span>),</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>    kernel_initializer<span class="op">=</span><span class="st">"ones"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>)</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>config <span class="op">=</span> keras.layers.serialize(layer)</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="bu">print</span>(config)</span></code></pre></div>
<p>As shown, the <code>registered_name</code> key contains the lookup
information for the Keras master list, including the package
<code>MyLayers</code> and the custom name <code>KernelMult</code> that
we gave in the <code>@keras.saving.register_keras_serializable</code>
decorator. Take a look again at the custom class definition/registration
<a href="#registration_example">here</a>.</p>
<p>Note that the <code>class_name</code> key contains the original name
of the class, allowing for proper re-initialization in
<code>from_config</code>.</p>
<p>Additionally, note that the <code>module</code> key is
<code>None</code> since this is a custom object.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet, RStudio, Google.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
