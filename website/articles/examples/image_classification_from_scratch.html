<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image classification from scratch • keras</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<script src="../../extra.js"></script><meta property="og:title" content="Image classification from scratch">
<meta property="og:description" content="Training an image classifier from scratch on the Kaggle Cats vs Dogs dataset.">
<meta property="og:image" content="https://keras.posit.co/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">keras</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.13.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="../../articles/tutorial_basic_classification.html">Basic Classification</a>
    </li>
    <li>
      <a href="../../articles/tutorial_basic_text_classification.html">Text Classification</a>
    </li>
    <li>
      <a href="../../articles/tutorial_basic_regression.html">Basic Regression</a>
    </li>
    <li>
      <a href="../../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    </li>
    <li>
      <a href="../../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Guides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Guides (New for TF 2.6)</li>
    <li>
      <a href="../../articles/new-guides/python_subclasses.html">Python Subclasses</a>
    </li>
    <li>
      <a href="../../articles/new-guides/making_new_layers_and_models_via_subclassing.html">Making New Layers and Models via Subclassing</a>
    </li>
    <li>
      <a href="../../articles/new-guides/customizing_what_happens_in_fit.html">Customizing What Happens in Fit</a>
    </li>
    <li>
      <a href="../../articles/new-guides/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    </li>
    <li>
      <a href="../../articles/new-guides/preprocessing_layers.html">Working with Preprocessing Layers</a>
    </li>
    <li>
      <a href="../../argicles/new-guides/working_with_rnns.html">Working with RNNs</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Using Keras</li>
    <li>
      <a href="../../articles/guide_keras.html">Guide to Keras Basics</a>
    </li>
    <li>
      <a href="../../articles/sequential_model.html">Sequential Model in Depth</a>
    </li>
    <li>
      <a href="../../articles/functional_api.html">Functional API in Depth</a>
    </li>
    <li>
      <a href="../../articles/about_keras_models.html">About Keras Models</a>
    </li>
    <li>
      <a href="../../articles/about_keras_layers.html">About Keras Layers</a>
    </li>
    <li>
      <a href="../../articles/training_visualization.html">Training Visualization</a>
    </li>
    <li>
      <a href="../../articles/applications.html">Pre-Trained Models</a>
    </li>
    <li>
      <a href="../../articles/faq.html">Frequently Asked Questions</a>
    </li>
    <li>
      <a href="../../articles/why_use_keras.html">Why Use Keras?</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Advanced</li>
    <li>
      <a href="../../articles/eager_guide.html">Eager Execution</a>
    </li>
    <li>
      <a href="../../articles/training_callbacks.html">Training Callbacks</a>
    </li>
    <li>
      <a href="../../articles/backend.html">Keras Backend</a>
    </li>
    <li>
      <a href="../../articles/custom_layers.html">Custom Layers</a>
    </li>
    <li>
      <a href="../../articles/custom_models.html">Custom Models</a>
    </li>
    <li>
      <a href="../../articles/saving_serializing.html">Saving and serializing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../articles/learn.html">Learn</a>
</li>
<li>
  <a href="../../articles/tools.html">Tools</a>
</li>
<li>
  <a href="../../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/keras/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Image classification from scratch</h1>
                        <h4 data-toc-skip class="author"><a href="https://twitter.com/fchollet" class="external-link">fchollet</a></h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/HEAD/vignettes/examples/image_classification_from_scratch.Rmd" class="external-link"><code>vignettes/examples/image_classification_from_scratch.Rmd</code></a></small>
      <div class="hidden name"><code>image_classification_from_scratch.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This example shows how to do image classification from scratch,
starting from JPEG image files on disk, without leveraging pre-trained
weights or a pre-made Keras Application model. We demonstrate the
workflow on the Kaggle Cats vs Dogs binary classification dataset.</p>
<p>We use the <code>image_dataset_from_directory</code> utility to
generate the datasets, and we use Keras image preprocessing layers for
image standardization and data augmentation.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> keras <span class="im">as</span> keras</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> layers</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-the-data-the-cats-vs-dogs-dataset">Load the data: the Cats vs Dogs dataset<a class="anchor" aria-label="anchor" href="#load-the-data-the-cats-vs-dogs-dataset"></a>
</h2>
<div class="section level3">
<h3 id="raw-data-download">Raw data download<a class="anchor" aria-label="anchor" href="#raw-data-download"></a>
</h3>
<p>First, let’s download the 786M ZIP archive of the raw data:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>fpath <span class="op">=</span> keras.utils.get_file(</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    origin<span class="op">=</span><span class="st">"https://download.microsoft.com/download/3/E/1/3E1C3F21-ECDB-4869-8368-6DEBA77B919F/kagglecatsanddogs_5340.zip"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>dirpath <span class="op">=</span> Path(fpath).parent.absolute()</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>os.system(<span class="ss">f"unzip -q </span><span class="sc">{</span>fpath<span class="sc">}</span><span class="ss"> -d </span><span class="sc">{</span>dirpath<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div>
<p>Now we have a <code>PetImages</code> folder which contain two
subfolders, <code>Cat</code> and <code>Dog</code>. Each subfolder
contains image files for each category.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>os.system(<span class="ss">f"ls </span><span class="sc">{</span>dirpath<span class="sc">}</span><span class="ss">/PetImages/"</span>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="filter-out-corrupted-images">Filter out corrupted images<a class="anchor" aria-label="anchor" href="#filter-out-corrupted-images"></a>
</h3>
<p>When working with lots of real-world image data, corrupted images are
a common occurence. Let’s filter out badly-encoded images that do not
feature the string “JFIF” in their header.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>num_skipped <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="cf">for</span> folder_name <span class="kw">in</span> (<span class="st">"Cat"</span>, <span class="st">"Dog"</span>):</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    folder_path <span class="op">=</span> os.path.join(dirpath, <span class="st">"PetImages"</span>, folder_name)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    <span class="cf">for</span> fname <span class="kw">in</span> os.listdir(folder_path):</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>        fpath <span class="op">=</span> os.path.join(folder_path, fname)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>            fobj <span class="op">=</span> <span class="bu">open</span>(fpath, <span class="st">"rb"</span>)</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>            is_jfif <span class="op">=</span> tf.compat.as_bytes(<span class="st">"JFIF"</span>) <span class="kw">in</span> fobj.peek(<span class="dv">10</span>)</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>            fobj.close()</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> is_jfif:</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>            num_skipped <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>            <span class="co"># Delete corrupted image</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>            os.remove(fpath)</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Deleted </span><span class="sc">{</span>num_skipped<span class="sc">}</span><span class="ss"> images"</span>)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="generate-a-dataset">Generate a <code>Dataset</code><a class="anchor" aria-label="anchor" href="#generate-a-dataset"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>image_size <span class="op">=</span> (<span class="dv">180</span>, <span class="dv">180</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>train_ds, val_ds <span class="op">=</span> keras.utils.image_dataset_from_directory(</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    os.path.join(dirpath, <span class="st">"PetImages"</span>),</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    validation_split<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    subset<span class="op">=</span><span class="st">"both"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">1337</span>,</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    image_size<span class="op">=</span>image_size,</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-the-data">Visualize the data<a class="anchor" aria-label="anchor" href="#visualize-the-data"></a>
</h2>
<p>Here are the first 9 images in the training dataset. As you can see,
label 1 is “dog” and label 0 is “cat”.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="cf">for</span> images, labels <span class="kw">in</span> train_ds.take(<span class="dv">1</span>):</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>):</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>        ax <span class="op">=</span> plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>        plt.imshow(images[i].numpy().astype(<span class="st">"uint8"</span>))</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>        plt.title(<span class="bu">int</span>(labels[i]))</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>        plt.axis(<span class="st">"off"</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-image-data-augmentation">Using image data augmentation<a class="anchor" aria-label="anchor" href="#using-image-data-augmentation"></a>
</h2>
<p>When you don’t have a large image dataset, it’s a good practice to
artificially introduce sample diversity by applying random yet realistic
transformations to the training images, such as random horizontal
flipping or small random rotations. This helps expose the model to
different aspects of the training data while slowing down
overfitting.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>data_augmentation <span class="op">=</span> keras.Sequential(</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    [</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>        layers.RandomFlip(<span class="st">"horizontal"</span>),</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>        layers.RandomRotation(<span class="fl">0.1</span>),</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>    ]</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Let’s visualize what the augmented samples look like, by applying
<code>data_augmentation</code> repeatedly to the first image in the
dataset:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="cf">for</span> images, _ <span class="kw">in</span> train_ds.take(<span class="dv">1</span>):</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>):</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>        augmented_images <span class="op">=</span> data_augmentation(images)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>        ax <span class="op">=</span> plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>        plt.imshow(augmented_images[<span class="dv">0</span>].numpy().astype(<span class="st">"uint8"</span>))</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>        plt.axis(<span class="st">"off"</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="standardizing-the-data">Standardizing the data<a class="anchor" aria-label="anchor" href="#standardizing-the-data"></a>
</h2>
<p>Our image are already in a standard size (180x180), as they are being
yielded as contiguous <code>float32</code> batches by our dataset.
However, their RGB channel values are in the <code>[0, 255]</code>
range. This is not ideal for a neural network; in general you should
seek to make your input values small. Here, we will standardize values
to be in the <code>[0, 1]</code> by using a <code>Rescaling</code> layer
at the start of our model.</p>
</div>
<div class="section level2">
<h2 id="two-options-to-preprocess-the-data">Two options to preprocess the data<a class="anchor" aria-label="anchor" href="#two-options-to-preprocess-the-data"></a>
</h2>
<p>There are two ways you could be using the
<code>data_augmentation</code> preprocessor:</p>
<p><strong>Option 1: Make it part of the model</strong>, like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>inputs <span class="op">=</span> keras.Input(shape<span class="op">=</span>input_shape)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>x <span class="op">=</span> data_augmentation(inputs)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>x <span class="op">=</span> layers.Rescaling(<span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>)(x)</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>...  <span class="co"># Rest of the model</span></span></code></pre></div>
<p>With this option, your data augmentation will happen <em>on
device</em>, synchronously with the rest of the model execution, meaning
that it will benefit from GPU acceleration.</p>
<p>Note that data augmentation is inactive at test time, so the input
samples will only be augmented during <code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code>, not when
calling <code><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html" class="external-link">evaluate()</a></code> or <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>.</p>
<p>If you’re training on GPU, this may be a good option.</p>
<p><strong>Option 2: apply it to the dataset</strong>, so as to obtain a
dataset that yields batches of augmented images, like this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>augmented_train_ds <span class="op">=</span> train_ds.<span class="bu">map</span>(</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    <span class="kw">lambda</span> x, y: (data_augmentation(x, training<span class="op">=</span><span class="va">True</span>), y))</span></code></pre></div>
<p>With this option, your data augmentation will happen <strong>on
CPU</strong>, asynchronously, and will be buffered before going into the
model.</p>
<p>If you’re training on CPU, this is the better option, since it makes
data augmentation asynchronous and non-blocking.</p>
<p>In our case, we’ll go with the second option. If you’re not sure
which one to pick, this second option (asynchronous preprocessing) is
always a solid choice.</p>
</div>
<div class="section level2">
<h2 id="configure-the-dataset-for-performance">Configure the dataset for performance<a class="anchor" aria-label="anchor" href="#configure-the-dataset-for-performance"></a>
</h2>
<p>Let’s apply data augmentation to our training dataset, and let’s make
sure to use buffered prefetching so we can yield data from disk without
having I/O becoming blocking:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Make datasets"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co"># Apply `data_augmentation` to the training images.</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>train_ds <span class="op">=</span> train_ds.<span class="bu">map</span>(</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    <span class="kw">lambda</span> img, label: (data_augmentation(img), label),</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    num_parallel_calls<span class="op">=</span>tf.data.AUTOTUNE,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co"># Prefetching samples in GPU memory helps maximize GPU utilization.</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>train_ds <span class="op">=</span> train_ds.prefetch(tf.data.AUTOTUNE)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>val_ds <span class="op">=</span> val_ds.prefetch(tf.data.AUTOTUNE)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="build-a-model">Build a model<a class="anchor" aria-label="anchor" href="#build-a-model"></a>
</h2>
<p>We’ll build a small version of the Xception network. We haven’t
particularly tried to optimize the architecture; if you want to do a
systematic search for the best model configuration, consider using <a href="https://github.com/keras-team/keras-tuner" class="external-link">KerasTuner</a>.</p>
<p>Note that:</p>
<ul>
<li>We start the model with the <code>data_augmentation</code>
preprocessor, followed by a <code>Rescaling</code> layer.</li>
<li>We include a <code>Dropout</code> layer before the final
classification layer.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">def</span> make_model(input_shape, num_classes):</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>    inputs <span class="op">=</span> keras.Input(shape<span class="op">=</span>input_shape)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="co"># Entry block</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    x <span class="op">=</span> layers.Rescaling(<span class="fl">1.0</span> <span class="op">/</span> <span class="dv">255</span>)(inputs)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    x <span class="op">=</span> layers.Conv2D(<span class="dv">128</span>, <span class="dv">3</span>, strides<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="st">"same"</span>)(x)</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    x <span class="op">=</span> layers.BatchNormalization()(x)</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>    x <span class="op">=</span> layers.Activation(<span class="st">"relu"</span>)(x)</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>    previous_block_activation <span class="op">=</span> x  <span class="co"># Set aside residual</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>    <span class="cf">for</span> size <span class="kw">in</span> [<span class="dv">256</span>, <span class="dv">512</span>, <span class="dv">728</span>]:</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>        x <span class="op">=</span> layers.Activation(<span class="st">"relu"</span>)(x)</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>        x <span class="op">=</span> layers.SeparableConv2D(size, <span class="dv">3</span>, padding<span class="op">=</span><span class="st">"same"</span>)(x)</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>        x <span class="op">=</span> layers.BatchNormalization()(x)</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>        x <span class="op">=</span> layers.Activation(<span class="st">"relu"</span>)(x)</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>        x <span class="op">=</span> layers.SeparableConv2D(size, <span class="dv">3</span>, padding<span class="op">=</span><span class="st">"same"</span>)(x)</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>        x <span class="op">=</span> layers.BatchNormalization()(x)</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>        x <span class="op">=</span> layers.MaxPooling2D(<span class="dv">3</span>, strides<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="st">"same"</span>)(x)</span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>        <span class="co"># Project residual</span></span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>        residual <span class="op">=</span> layers.Conv2D(size, <span class="dv">1</span>, strides<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="st">"same"</span>)(</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>            previous_block_activation</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>        )</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>        x <span class="op">=</span> layers.add([x, residual])  <span class="co"># Add back residual</span></span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>        previous_block_activation <span class="op">=</span> x  <span class="co"># Set aside next residual</span></span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>    x <span class="op">=</span> layers.SeparableConv2D(<span class="dv">1024</span>, <span class="dv">3</span>, padding<span class="op">=</span><span class="st">"same"</span>)(x)</span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>    x <span class="op">=</span> layers.BatchNormalization()(x)</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>    x <span class="op">=</span> layers.Activation(<span class="st">"relu"</span>)(x)</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>    x <span class="op">=</span> layers.GlobalAveragePooling2D()(x)</span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a>    <span class="cf">if</span> num_classes <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a>        activation <span class="op">=</span> <span class="st">"sigmoid"</span></span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>        units <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a>        activation <span class="op">=</span> <span class="st">"softmax"</span></span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a>        units <span class="op">=</span> num_classes</span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a>    x <span class="op">=</span> layers.Dropout(<span class="fl">0.5</span>)(x)</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a>    outputs <span class="op">=</span> layers.Dense(units, activation<span class="op">=</span>activation)(x)</span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a>    <span class="cf">return</span> keras.Model(inputs, outputs)</span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a></span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a>model <span class="op">=</span> make_model(input_shape<span class="op">=</span>image_size <span class="op">+</span> (<span class="dv">3</span>,), num_classes<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a>keras.utils.plot_model(model, show_shapes<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="train-the-model">Train the model<a class="anchor" aria-label="anchor" href="#train-the-model"></a>
</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>callbacks <span class="op">=</span> [</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    keras.callbacks.ModelCheckpoint(<span class="st">"save_at_</span><span class="sc">{epoch}</span><span class="st">.keras"</span>),</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>]</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    optimizer<span class="op">=</span>keras.optimizers.Adam(<span class="fl">1e-3</span>),</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    loss<span class="op">=</span><span class="st">"binary_crossentropy"</span>,</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>    metrics<span class="op">=</span>[<span class="st">"accuracy"</span>],</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>)</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>model.fit(</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>    train_ds,</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>    callbacks<span class="op">=</span>callbacks,</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>    validation_data<span class="op">=</span>val_ds,</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>)</span></code></pre></div>
<p>We get to &gt;90% validation accuracy after training for 25 epochs on
the full dataset (in practice, you can train for 50+ epochs before
validation performance starts degrading).</p>
</div>
<div class="section level2">
<h2 id="run-inference-on-new-data">Run inference on new data<a class="anchor" aria-label="anchor" href="#run-inference-on-new-data"></a>
</h2>
<p>Note that data augmentation and dropout are inactive at inference
time.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>img <span class="op">=</span> keras.utils.load_img(</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>dirpath<span class="sc">}</span><span class="ss">/PetImages/Cat/6779.jpg"</span>, target_size<span class="op">=</span>image_size</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>)</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>img_array <span class="op">=</span> keras.utils.img_to_array(img)</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>img_array <span class="op">=</span> tf.expand_dims(img_array, <span class="dv">0</span>)  <span class="co"># Create batch axis</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(img_array)</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>score <span class="op">=</span> <span class="bu">float</span>(predictions[<span class="dv">0</span>])</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"This image is </span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> score)<span class="sc">:.2f}</span><span class="ss">% cat and </span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> score<span class="sc">:.2f}</span><span class="ss">% dog."</span>)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet, RStudio, Google.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
