<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Similarity learning using a siamese network trained with a contrastive loss.">
<title>Image similarity estimation using a Siamese Network with a contrastive loss â€¢ keras3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Image similarity estimation using a Siamese Network with a contrastive loss">
<meta property="og:description" content="Similarity learning using a siamese network trained with a contrastive loss.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">keras3</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.13.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../index.html">Home</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-getting-started">Getting Started</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-getting-started">
    <a class="dropdown-item" href="../../articles/intro_to_keras_for_engineers.html">Introduction to Keras for engineers</a>
    <h6 class="dropdown-header" data-toc-skip>Tutorials</h6>
    <a class="dropdown-item" href="../../articles/getting_started.html">Getting Started</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_classification.html">Basic Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_text_classification.html">Text Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_regression.html">Basic Regression</a>
    <a class="dropdown-item" href="../../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    <a class="dropdown-item" href="../../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-guides">Guides</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-guides">
    <h6 class="dropdown-header" data-toc-skip>Model definition</h6>
    <a class="dropdown-item" href="../../articles/functional_api.html">Functional API</a>
    <a class="dropdown-item" href="../../articles/sequential_model.html">Sequential Model</a>
    <h6 class="dropdown-header" data-toc-skip>Extending and customizing</h6>
    <a class="dropdown-item" href="../../articles/making_new_layers_and_models_via_subclassing.html">Making new layers and models via subclassing</a>
    <a class="dropdown-item" href="../../articles/training_with_built_in_methods.html">Training &amp; evaluation with the built-in methods</a>
    <a class="dropdown-item" href="../../articles/writing_a_custom_training_loop_in_tensorflow.html">Writing a training loop from scratch in TensorFlow</a>
    <a class="dropdown-item" href="../../articles/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    <h6 class="dropdown-header" data-toc-skip>Other topics</h6>
    <a class="dropdown-item" href="../../articles/transfer_learning.html">Transfer learning and fine tuning</a>
    <a class="dropdown-item" href="../../articles/distributed_training_with_tensorflow.html">Distributed training with TensorFlow</a>
  </div>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../../articles/examples/index.html">Examples</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rstudio/keras/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Image similarity estimation using a Siamese Network with a contrastive loss</h1>
                        <h4 data-toc-skip class="author">Mehdi</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/HEAD/vignettes/examples/siamese_contrastive.Rmd" class="external-link"><code>vignettes/examples/siamese_contrastive.Rmd</code></a></small>
      <div class="d-none name"><code>siamese_contrastive.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><a href="https://en.wikipedia.org/wiki/Siamese_neural_network" class="external-link">Siamese
Networks</a> are neural networks which share weights between two or more
sister networks, each producing embedding vectors of its respective
inputs.</p>
<p>In supervised similarity learning, the networks are then trained to
maximize the contrast (distance) between embeddings of inputs of
different classes, while minimizing the distance between embeddings of
similar classes, resulting in embedding spaces that reflect the class
segmentation of the training inputs.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">import</span> keras <span class="im">as</span> keras</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> ops</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hyperparameters">Hyperparameters<a class="anchor" aria-label="anchor" href="#hyperparameters"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>margin <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Margin for contrastive loss.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-the-mnist-dataset">Load the MNIST dataset<a class="anchor" aria-label="anchor" href="#load-the-mnist-dataset"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>(x_train_val, y_train_val), (x_test, y_test) <span class="op">=</span> keras.datasets.mnist.load_data()</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co"># Change the data type to a floating point format</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>x_train_val <span class="op">=</span> x_train_val.astype(<span class="st">"float32"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>x_test <span class="op">=</span> x_test.astype(<span class="st">"float32"</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-training-and-validation-sets">Define training and validation sets<a class="anchor" aria-label="anchor" href="#define-training-and-validation-sets"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Keep 50% of train_val  in validation set</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>x_train, x_val <span class="op">=</span> x_train_val[:<span class="dv">30000</span>], x_train_val[<span class="dv">30000</span>:]</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>y_train, y_val <span class="op">=</span> y_train_val[:<span class="dv">30000</span>], y_train_val[<span class="dv">30000</span>:]</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="kw">del</span> x_train_val, y_train_val</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-pairs-of-images">Create pairs of images<a class="anchor" aria-label="anchor" href="#create-pairs-of-images"></a>
</h2>
<p>We will train the model to differentiate between digits of different
classes. For example, digit <code>0</code> needs to be differentiated
from the rest of the digits (<code>1</code> through <code>9</code>),
digit <code>1</code> - from <code>0</code> and <code>2</code> through
<code>9</code>, and so on. To carry this out, we will select N random
images from class A (for example, for digit <code>0</code>) and pair
them with N random images from another class B (for example, for digit
<code>1</code>). Then, we can repeat this process for all classes of
digits (until digit <code>9</code>). Once we have paired digit
<code>0</code> with other digits, we can repeat this process for the
remaining classes for the rest of the digits (from <code>1</code> until
<code>9</code>).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">def</span> make_pairs(x, y):</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="co">"""Creates a tuple containing image pairs with corresponding label.</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">    Arguments:</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">        x: List containing images, each index in this list corresponds to one image.</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">        y: List containing labels, each label with datatype of `int`.</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">        Tuple containing two numpy arrays as (pairs_of_samples, labels),</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co">        where pairs_of_samples' shape is (2len(x), 2,n_features_dims) and</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co">        labels are a binary array of shape (2len(x)).</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>    num_classes <span class="op">=</span> <span class="bu">max</span>(y) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>    digit_indices <span class="op">=</span> [np.where(y <span class="op">==</span> i)[<span class="dv">0</span>] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_classes)]</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    pairs <span class="op">=</span> []</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>    labels <span class="op">=</span> []</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>    <span class="cf">for</span> idx1 <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(x)):</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>        <span class="co"># add a matching example</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>        x1 <span class="op">=</span> x[idx1]</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>        label1 <span class="op">=</span> y[idx1]</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>        idx2 <span class="op">=</span> random.choice(digit_indices[label1])</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>        x2 <span class="op">=</span> x[idx2]</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>        pairs <span class="op">+=</span> [[x1, x2]]</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>        labels <span class="op">+=</span> [<span class="dv">0</span>]</span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>        <span class="co"># add a non-matching example</span></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>        label2 <span class="op">=</span> random.randint(<span class="dv">0</span>, num_classes <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>        <span class="cf">while</span> label2 <span class="op">==</span> label1:</span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>            label2 <span class="op">=</span> random.randint(<span class="dv">0</span>, num_classes <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>        idx2 <span class="op">=</span> random.choice(digit_indices[label2])</span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>        x2 <span class="op">=</span> x[idx2]</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>        pairs <span class="op">+=</span> [[x1, x2]]</span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>        labels <span class="op">+=</span> [<span class="dv">1</span>]</span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>    <span class="cf">return</span> np.array(pairs), np.array(labels).astype(<span class="st">"float32"</span>)</span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a><span class="co"># make train pairs</span></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>pairs_train, labels_train <span class="op">=</span> make_pairs(x_train, y_train)</span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a><span class="co"># make validation pairs</span></span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>pairs_val, labels_val <span class="op">=</span> make_pairs(x_val, y_val)</span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a><span class="co"># make test pairs</span></span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a>pairs_test, labels_test <span class="op">=</span> make_pairs(x_test, y_test)</span></code></pre></div>
<p>We get:</p>
<p><strong>pairs_train.shape = (60000, 2, 28, 28)</strong></p>
<ul>
<li>We have 60,000 pairs</li>
<li>Each pair contains 2 images</li>
<li>Each image has shape <code>(28, 28)</code>
</li>
</ul>
<p>Split the training pairs</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>x_train_1 <span class="op">=</span> pairs_train[:, <span class="dv">0</span>]  <span class="co"># x_train_1.shape is (60000, 28, 28)</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>x_train_2 <span class="op">=</span> pairs_train[:, <span class="dv">1</span>]</span></code></pre></div>
<p>Split the validation pairs</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>x_val_1 <span class="op">=</span> pairs_val[:, <span class="dv">0</span>]  <span class="co"># x_val_1.shape = (60000, 28, 28)</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>x_val_2 <span class="op">=</span> pairs_val[:, <span class="dv">1</span>]</span></code></pre></div>
<p>Split the test pairs</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>x_test_1 <span class="op">=</span> pairs_test[:, <span class="dv">0</span>]  <span class="co"># x_test_1.shape = (20000, 28, 28)</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>x_test_2 <span class="op">=</span> pairs_test[:, <span class="dv">1</span>]</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-pairs-and-their-labels">Visualize pairs and their labels<a class="anchor" aria-label="anchor" href="#visualize-pairs-and-their-labels"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">def</span> visualize(</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    pairs, labels, to_show<span class="op">=</span><span class="dv">6</span>, num_col<span class="op">=</span><span class="dv">3</span>, predictions<span class="op">=</span><span class="va">None</span>, test<span class="op">=</span><span class="va">False</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>):</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>    <span class="co">"""Creates a plot of pairs and labels, and prediction if it's test dataset.</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">    Arguments:</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co">        pairs: Numpy Array, of pairs to visualize, having shape</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="co">               (Number of pairs, 2, 28, 28).</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co">        to_show: Int, number of examples to visualize (default is 6)</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co">                `to_show` must be an integral multiple of `num_col`.</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="co">                 Otherwise it will be trimmed if it is greater than num_col,</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="co">                 and incremented if if it is less then num_col.</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="co">        num_col: Int, number of images in one row - (default is 3)</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="co">                 For test and train respectively, it should not exceed 3 and 7.</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="co">        predictions: Numpy Array of predictions with shape (to_show, 1) -</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="co">                     (default is None)</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="co">                     Must be passed when test=True.</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a><span class="co">        test: Boolean telling whether the dataset being visualized is</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a><span class="co">              train dataset or test dataset - (default False).</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a><span class="co">        None.</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>    <span class="co"># Define num_row</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>    <span class="co"># If to_show % num_col != 0</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>    <span class="co">#    trim to_show,</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>    <span class="co">#       to trim to_show limit num_row to the point where</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>    <span class="co">#       to_show % num_col == 0</span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>    <span class="co"># If to_show//num_col == 0</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a>    <span class="co">#    then it means num_col is greater then to_show</span></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>    <span class="co">#    increment to_show</span></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>    <span class="co">#       to increment to_show set num_row to 1</span></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>    num_row <span class="op">=</span> to_show <span class="op">//</span> num_col <span class="cf">if</span> to_show <span class="op">//</span> num_col <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a>    <span class="co"># `to_show` must be an integral multiple of `num_col`</span></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>    <span class="co">#  we found num_row and we have num_col</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a>    <span class="co">#  to increment or decrement to_show</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a>    <span class="co">#  to make it integral multiple of `num_col`</span></span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a>    <span class="co">#  simply set it equal to num_row * num_col</span></span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a>    to_show <span class="op">=</span> num_row <span class="op">*</span> num_col</span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a>    <span class="co"># Plot the images</span></span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(num_row, num_col, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(to_show):</span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a>        <span class="co"># If the number of rows is 1, the axes array is one-dimensional</span></span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a>        <span class="cf">if</span> num_row <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a>            ax <span class="op">=</span> axes[i <span class="op">%</span> num_col]</span>
<span id="cb9-50"><a href="#cb9-50" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-51"><a href="#cb9-51" tabindex="-1"></a>            ax <span class="op">=</span> axes[i <span class="op">//</span> num_col, i <span class="op">%</span> num_col]</span>
<span id="cb9-52"><a href="#cb9-52" tabindex="-1"></a></span>
<span id="cb9-53"><a href="#cb9-53" tabindex="-1"></a>        ax.imshow(</span>
<span id="cb9-54"><a href="#cb9-54" tabindex="-1"></a>            ops.concatenate([pairs[i][<span class="dv">0</span>], pairs[i][<span class="dv">1</span>]], axis<span class="op">=</span><span class="dv">1</span>), cmap<span class="op">=</span><span class="st">"gray"</span></span>
<span id="cb9-55"><a href="#cb9-55" tabindex="-1"></a>        )</span>
<span id="cb9-56"><a href="#cb9-56" tabindex="-1"></a>        ax.set_axis_off()</span>
<span id="cb9-57"><a href="#cb9-57" tabindex="-1"></a>        <span class="cf">if</span> test:</span>
<span id="cb9-58"><a href="#cb9-58" tabindex="-1"></a>            ax.set_title(</span>
<span id="cb9-59"><a href="#cb9-59" tabindex="-1"></a>                <span class="st">"True: </span><span class="sc">{}</span><span class="st"> | Pred: </span><span class="sc">{:.5f}</span><span class="st">"</span>.<span class="bu">format</span>(labels[i], predictions[i][<span class="dv">0</span>])</span>
<span id="cb9-60"><a href="#cb9-60" tabindex="-1"></a>            )</span>
<span id="cb9-61"><a href="#cb9-61" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-62"><a href="#cb9-62" tabindex="-1"></a>            ax.set_title(<span class="st">"Label: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(labels[i]))</span>
<span id="cb9-63"><a href="#cb9-63" tabindex="-1"></a>    <span class="cf">if</span> test:</span>
<span id="cb9-64"><a href="#cb9-64" tabindex="-1"></a>        plt.tight_layout(rect<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">1.9</span>, <span class="fl">1.9</span>), w_pad<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb9-65"><a href="#cb9-65" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-66"><a href="#cb9-66" tabindex="-1"></a>        plt.tight_layout(rect<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">1.5</span>, <span class="fl">1.5</span>))</span>
<span id="cb9-67"><a href="#cb9-67" tabindex="-1"></a>    plt.show()</span></code></pre></div>
<p>Inspect training pairs</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>visualize(pairs_train[:<span class="op">-</span><span class="dv">1</span>], labels_train[:<span class="op">-</span><span class="dv">1</span>], to_show<span class="op">=</span><span class="dv">4</span>, num_col<span class="op">=</span><span class="dv">4</span>)</span></code></pre></div>
<p>Inspect validation pairs</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>visualize(pairs_val[:<span class="op">-</span><span class="dv">1</span>], labels_val[:<span class="op">-</span><span class="dv">1</span>], to_show<span class="op">=</span><span class="dv">4</span>, num_col<span class="op">=</span><span class="dv">4</span>)</span></code></pre></div>
<p>Inspect test pairs</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>visualize(pairs_test[:<span class="op">-</span><span class="dv">1</span>], labels_test[:<span class="op">-</span><span class="dv">1</span>], to_show<span class="op">=</span><span class="dv">4</span>, num_col<span class="op">=</span><span class="dv">4</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-the-model">Define the model<a class="anchor" aria-label="anchor" href="#define-the-model"></a>
</h2>
<p>There are two input layers, each leading to its own network, which
produces embeddings. A <code>Lambda</code> layer then merges them using
an <a href="https://en.wikipedia.org/wiki/Euclidean_distance" class="external-link">Euclidean
distance</a> and the merged output is fed to the final network.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Provided two tensors t1 and t2</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="co"># Euclidean distance = sqrt(sum(square(t1-t2)))</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="kw">def</span> euclidean_distance(vects):</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    <span class="co">"""Find the Euclidean distance between two vectors.</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co">    Arguments:</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co">        vects: List containing two tensors of same length.</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="co">        Tensor containing euclidean distance</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="co">        (as floating point value) between vectors.</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    x, y <span class="op">=</span> vects</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>    sum_square <span class="op">=</span> ops.<span class="bu">sum</span>(ops.square(x <span class="op">-</span> y), axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>    <span class="cf">return</span> ops.sqrt(ops.maximum(sum_square, keras.backend.epsilon()))</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a><span class="bu">input</span> <span class="op">=</span> keras.layers.Input((<span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))</span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>x <span class="op">=</span> keras.layers.BatchNormalization()(<span class="bu">input</span>)</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Conv2D(<span class="dv">4</span>, (<span class="dv">5</span>, <span class="dv">5</span>), activation<span class="op">=</span><span class="st">"tanh"</span>)(x)</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>x <span class="op">=</span> keras.layers.AveragePooling2D(pool_size<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">2</span>))(x)</span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Conv2D(<span class="dv">16</span>, (<span class="dv">5</span>, <span class="dv">5</span>), activation<span class="op">=</span><span class="st">"tanh"</span>)(x)</span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>x <span class="op">=</span> keras.layers.AveragePooling2D(pool_size<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">2</span>))(x)</span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Flatten()(x)</span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>x <span class="op">=</span> keras.layers.BatchNormalization()(x)</span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dense(<span class="dv">10</span>, activation<span class="op">=</span><span class="st">"tanh"</span>)(x)</span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a>embedding_network <span class="op">=</span> keras.Model(<span class="bu">input</span>, x)</span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a>input_1 <span class="op">=</span> keras.layers.Input((<span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))</span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a>input_2 <span class="op">=</span> keras.layers.Input((<span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))</span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a><span class="co"># As mentioned above, Siamese Network share weights between</span></span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a><span class="co"># tower networks (sister networks). To allow this, we will use</span></span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a><span class="co"># same embedding network for both tower networks.</span></span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a>tower_1 <span class="op">=</span> embedding_network(input_1)</span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a>tower_2 <span class="op">=</span> embedding_network(input_2)</span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a>merge_layer <span class="op">=</span> keras.layers.Lambda(euclidean_distance, output_shape<span class="op">=</span>(<span class="dv">1</span>,))(</span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a>    [tower_1, tower_2]</span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a>)</span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a>normal_layer <span class="op">=</span> keras.layers.BatchNormalization()(merge_layer)</span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a>output_layer <span class="op">=</span> keras.layers.Dense(<span class="dv">1</span>, activation<span class="op">=</span><span class="st">"sigmoid"</span>)(normal_layer)</span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a>siamese <span class="op">=</span> keras.Model(inputs<span class="op">=</span>[input_1, input_2], outputs<span class="op">=</span>output_layer)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-the-contrastive-loss">Define the contrastive Loss<a class="anchor" aria-label="anchor" href="#define-the-contrastive-loss"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">def</span> loss(margin<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    <span class="co">"""Provides 'contrastive_loss' an enclosing scope with variable 'margin'.</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co">    Arguments:</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="co">        margin: Integer, defines the baseline for distance for which pairs</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="co">                should be classified as dissimilar. - (default is 1).</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="co">        'contrastive_loss' function with data ('margin') attached.</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>    <span class="co"># Contrastive loss = mean( (1-true_value) * square(prediction) +</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>    <span class="co">#                         true_value * square( max(margin-prediction, 0) ))</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>    <span class="kw">def</span> contrastive_loss(y_true, y_pred):</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>        <span class="co">"""Calculates the contrastive loss.</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="co">        Arguments:</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a><span class="co">            y_true: List of labels, each label is of type float32.</span></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a><span class="co">            y_pred: List of predictions of same length as of y_true,</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a><span class="co">                    each label is of type float32.</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a><span class="co">            A tensor containing contrastive loss as floating point value.</span></span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>        square_pred <span class="op">=</span> ops.square(y_pred)</span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>        margin_square <span class="op">=</span> ops.square(ops.maximum(margin <span class="op">-</span> (y_pred), <span class="dv">0</span>))</span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a>        <span class="cf">return</span> ops.mean((<span class="dv">1</span> <span class="op">-</span> y_true) <span class="op">*</span> square_pred <span class="op">+</span> (y_true) <span class="op">*</span> margin_square)</span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a>    <span class="cf">return</span> contrastive_loss</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="compile-the-model-with-the-contrastive-loss">Compile the model with the contrastive loss<a class="anchor" aria-label="anchor" href="#compile-the-model-with-the-contrastive-loss"></a>
</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>siamese.<span class="bu">compile</span>(</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    loss<span class="op">=</span>loss(margin<span class="op">=</span>margin), optimizer<span class="op">=</span><span class="st">"RMSprop"</span>, metrics<span class="op">=</span>[<span class="st">"accuracy"</span>]</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>siamese.summary()</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="train-the-model">Train the model<a class="anchor" aria-label="anchor" href="#train-the-model"></a>
</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>history <span class="op">=</span> siamese.fit(</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>    [x_train_1, x_train_2],</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    labels_train,</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    validation_data<span class="op">=</span>([x_val_1, x_val_2], labels_val),</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-results">Visualize results<a class="anchor" aria-label="anchor" href="#visualize-results"></a>
</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="kw">def</span> plt_metric(history, metric, title, has_valid<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    <span class="co">"""Plots the given 'metric' from 'history'.</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co">    Arguments:</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co">        history: history attribute of History object returned from Model.fit.</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co">        metric: Metric to plot, a string value present as key in 'history'.</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="co">        title: A string to be used as title of plot.</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="co">        has_valid: Boolean, true if valid data was passed to Model.fit else false.</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="co">        None.</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>    plt.plot(history[metric])</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>    <span class="cf">if</span> has_valid:</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>        plt.plot(history[<span class="st">"val_"</span> <span class="op">+</span> metric])</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>        plt.legend([<span class="st">"train"</span>, <span class="st">"validation"</span>], loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>    plt.ylabel(metric)</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>    plt.xlabel(<span class="st">"epoch"</span>)</span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>    plt.show()</span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="co"># Plot the accuracy</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a>plt_metric(history<span class="op">=</span>history.history, metric<span class="op">=</span><span class="st">"accuracy"</span>, title<span class="op">=</span><span class="st">"Model accuracy"</span>)</span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a><span class="co"># Plot the contrastive loss</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a>plt_metric(history<span class="op">=</span>history.history, metric<span class="op">=</span><span class="st">"loss"</span>, title<span class="op">=</span><span class="st">"Contrastive Loss"</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="evaluate-the-model">Evaluate the model<a class="anchor" aria-label="anchor" href="#evaluate-the-model"></a>
</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>results <span class="op">=</span> siamese.evaluate([x_test_1, x_test_2], labels_test)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"test loss, test acc:"</span>, results)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-the-predictions">Visualize the predictions<a class="anchor" aria-label="anchor" href="#visualize-the-predictions"></a>
</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>predictions <span class="op">=</span> siamese.predict([x_test_1, x_test_2])</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>visualize(</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    pairs_test, labels_test, to_show<span class="op">=</span><span class="dv">3</span>, predictions<span class="op">=</span>predictions, test<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>)</span></code></pre></div>
<p><strong>Example available on HuggingFace</strong> | Trained Model |
Demo | | :â€“: | :â€“: | | <a href="https://huggingface.co/keras-io/siamese-contrastive" class="external-link"><img src="https://img.shields.io/badge/%F0%9F%A4%97%20Model-Siamese%20Network-black.svg" alt="Generic badge"></a> | <a href="https://huggingface.co/spaces/keras-io/siamese-contrastive" class="external-link"><img src="https://img.shields.io/badge/%F0%9F%A4%97%20Spaces-Siamese%20Network-black.svg" alt="Generic badge"></a> |</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tomasz Kalinowski, JJ Allaire, FranÃ§ois Chollet, Posit Software, PBC, Google.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
