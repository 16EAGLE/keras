<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Data augmentation with CutMix for image classification on CIFAR-10.">
<title>CutMix data augmentation for image classification • keras3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/Fira_Mono-0.4.8/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="CutMix data augmentation for image classification">
<meta property="og:description" content="Data augmentation with CutMix for image classification on CIFAR-10.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">keras3</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.13.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../index.html">Home</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-getting-started">Getting Started</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-getting-started">
    <a class="dropdown-item" href="../../articles/intro_to_keras_for_engineers.html">Introduction to Keras for engineers</a>
    <h6 class="dropdown-header" data-toc-skip>Tutorials</h6>
    <a class="dropdown-item" href="../../articles/getting_started.html">Getting Started</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_classification.html">Basic Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_text_classification.html">Text Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_regression.html">Basic Regression</a>
    <a class="dropdown-item" href="../../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    <a class="dropdown-item" href="../../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-guides">Guides</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-guides">
    <h6 class="dropdown-header" data-toc-skip>Model definition</h6>
    <a class="dropdown-item" href="../../articles/functional_api.html">Functional API</a>
    <a class="dropdown-item" href="../../articles/sequential_model.html">Sequential Model</a>
    <h6 class="dropdown-header" data-toc-skip>Extending and customizing</h6>
    <a class="dropdown-item" href="../../articles/making_new_layers_and_models_via_subclassing.html">Making new layers and models via subclassing</a>
    <a class="dropdown-item" href="../../articles/training_with_built_in_methods.html">Training &amp; evaluation with the built-in methods</a>
    <a class="dropdown-item" href="../../articles/writing_a_custom_training_loop_in_tensorflow.html">Writing a training loop from scratch in TensorFlow</a>
    <a class="dropdown-item" href="../../articles/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    <h6 class="dropdown-header" data-toc-skip>Other topics</h6>
    <a class="dropdown-item" href="../../articles/transfer_learning.html">Transfer learning and fine tuning</a>
    <a class="dropdown-item" href="../../articles/distributed_training_with_tensorflow.html">Distributed training with TensorFlow</a>
  </div>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../../articles/examples/index.html">Examples</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rstudio/keras/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>CutMix data augmentation for image classification</h1>
                        <h4 data-toc-skip class="author"><a href="https://twitter.com/sayannath2350" class="external-link">Sayan Nath</a></h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/HEAD/vignettes/examples/cutmix.Rmd" class="external-link"><code>vignettes/examples/cutmix.Rmd</code></a></small>
      <div class="d-none name"><code>cutmix.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><em>CutMix</em> is a data augmentation technique that addresses the
issue of information loss and inefficiency present in regional dropout
strategies. Instead of removing pixels and filling them with black or
grey pixels or Gaussian noise, you replace the removed regions with a
patch from another image, while the ground truth labels are mixed
proportionally to the number of pixels of combined images. CutMix was
proposed in <a href="https://arxiv.org/abs/1905.04899" class="external-link">CutMix:
Regularization Strategy to Train Strong Classifiers with Localizable
Features</a> (Yun et al., 2019)</p>
<p>It’s implemented via the following formulas:</p>
<p><img src="https://i.imgur.com/cGvd13V.png" width="200"></p>
<p>where <code>M</code> is the binary mask which indicates the cutout
and the fill-in regions from the two randomly drawn images and
<code>λ</code> (in <code>[0, 1]</code>) is drawn from a <a href="https://en.wikipedia.org/wiki/Beta_distribution" class="external-link"><code>Beta(α, α)</code>
distribution</a></p>
<p>The coordinates of bounding boxes are:</p>
<p><img src="https://i.imgur.com/eNisep4.png" width="150"></p>
<p>which indicates the cutout and fill-in regions in case of the images.
The bounding box sampling is represented by:</p>
<p><img src="https://i.imgur.com/Snph9aj.png" width="200"></p>
<p>where <code>rx, ry</code> are randomly drawn from a uniform
distribution with upper bound.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">import</span> keras <span class="im">as</span> keras</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> layers</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co"># TF imports related to tf.data preprocessing</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> clip_by_value</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> data <span class="im">as</span> tf_data</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> image <span class="im">as</span> tf_image</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="im">from</span> tensorflow.random <span class="im">import</span> gamma <span class="im">as</span> tf_random_gamma</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>keras.utils.set_random_seed(<span class="dv">42</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-the-cifar-10-dataset">Load the CIFAR-10 dataset<a class="anchor" aria-label="anchor" href="#load-the-cifar-10-dataset"></a>
</h2>
<p>In this example, we will use the <a href="https://www.cs.toronto.edu/~kriz/cifar.html" class="external-link">CIFAR-10 image
classification dataset</a>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>(x_train, y_train), (x_test, y_test) <span class="op">=</span> keras.datasets.cifar10.load_data()</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>y_train <span class="op">=</span> keras.utils.to_categorical(y_train, num_classes<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>y_test <span class="op">=</span> keras.utils.to_categorical(y_test, num_classes<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>class_names <span class="op">=</span> [</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>    <span class="st">"Airplane"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>    <span class="st">"Automobile"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    <span class="st">"Bird"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>    <span class="st">"Cat"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>    <span class="st">"Deer"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>    <span class="st">"Dog"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>    <span class="st">"Frog"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>    <span class="st">"Horse"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    <span class="st">"Ship"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    <span class="st">"Truck"</span>,</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>]</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-hyperparameters">Define hyperparameters<a class="anchor" aria-label="anchor" href="#define-hyperparameters"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>AUTO <span class="op">=</span> tf_data.AUTOTUNE</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>IMG_SIZE <span class="op">=</span> <span class="dv">32</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-the-image-preprocessing-function">Define the image preprocessing function<a class="anchor" aria-label="anchor" href="#define-the-image-preprocessing-function"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">def</span> preprocess_image(image, label):</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    image <span class="op">=</span> tf_image.resize(image, (IMG_SIZE, IMG_SIZE))</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    image <span class="op">=</span> tf_image.convert_image_dtype(image, <span class="st">"float32"</span>) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    label <span class="op">=</span> keras.backend.cast(label, dtype<span class="op">=</span><span class="st">"float32"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="cf">return</span> image, label</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="convert-the-data-into-tensorflow-dataset-objects">Convert the data into TensorFlow <code>Dataset</code> objects<a class="anchor" aria-label="anchor" href="#convert-the-data-into-tensorflow-dataset-objects"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>train_ds_one <span class="op">=</span> (</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    tf_data.Dataset.from_tensor_slices((x_train, y_train))</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    .shuffle(<span class="dv">1024</span>)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    .<span class="bu">map</span>(preprocess_image, num_parallel_calls<span class="op">=</span>AUTO)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>train_ds_two <span class="op">=</span> (</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    tf_data.Dataset.from_tensor_slices((x_train, y_train))</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>    .shuffle(<span class="dv">1024</span>)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    .<span class="bu">map</span>(preprocess_image, num_parallel_calls<span class="op">=</span>AUTO)</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>)</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>train_ds_simple <span class="op">=</span> tf_data.Dataset.from_tensor_slices((x_train, y_train))</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>test_ds <span class="op">=</span> tf_data.Dataset.from_tensor_slices((x_test, y_test))</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>train_ds_simple <span class="op">=</span> (</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    train_ds_simple.<span class="bu">map</span>(preprocess_image, num_parallel_calls<span class="op">=</span>AUTO)</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>    .batch(BATCH_SIZE)</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    .prefetch(AUTO)</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>)</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a><span class="co"># Combine two shuffled datasets from the same training data.</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>train_ds <span class="op">=</span> tf_data.Dataset.<span class="bu">zip</span>((train_ds_one, train_ds_two))</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>test_ds <span class="op">=</span> (</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>    test_ds.<span class="bu">map</span>(preprocess_image, num_parallel_calls<span class="op">=</span>AUTO)</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>    .batch(BATCH_SIZE)</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>    .prefetch(AUTO)</span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-the-cutmix-data-augmentation-function">Define the CutMix data augmentation function<a class="anchor" aria-label="anchor" href="#define-the-cutmix-data-augmentation-function"></a>
</h2>
<p>The CutMix function takes two <code>image</code> and
<code>label</code> pairs to perform the augmentation. It samples
<code>λ(l)</code> from the <a href="https://en.wikipedia.org/wiki/Beta_distribution" class="external-link">Beta
distribution</a> and returns a bounding box from <code>get_box</code>
function. We then crop the second image (<code>image2</code>) and pad
this image in the final padded image at the same location.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">def</span> sample_beta_distribution(size, concentration_0<span class="op">=</span><span class="fl">0.2</span>, concentration_1<span class="op">=</span><span class="fl">0.2</span>):</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>    gamma_1_sample <span class="op">=</span> tf_random_gamma(shape<span class="op">=</span>[size], alpha<span class="op">=</span>concentration_1)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    gamma_2_sample <span class="op">=</span> tf_random_gamma(shape<span class="op">=</span>[size], alpha<span class="op">=</span>concentration_0)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    <span class="cf">return</span> gamma_1_sample <span class="op">/</span> (gamma_1_sample <span class="op">+</span> gamma_2_sample)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="kw">def</span> get_box(lambda_value):</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    cut_rat <span class="op">=</span> keras.ops.sqrt(<span class="fl">1.0</span> <span class="op">-</span> lambda_value)</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>    cut_w <span class="op">=</span> IMG_SIZE <span class="op">*</span> cut_rat  <span class="co"># rw</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    cut_w <span class="op">=</span> keras.backend.cast(cut_w, <span class="st">"int32"</span>)</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>    cut_h <span class="op">=</span> IMG_SIZE <span class="op">*</span> cut_rat  <span class="co"># rh</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    cut_h <span class="op">=</span> keras.backend.cast(cut_h, <span class="st">"int32"</span>)</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    cut_x <span class="op">=</span> keras.random.random.uniform((<span class="dv">1</span>,), minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span>IMG_SIZE)  <span class="co"># rx</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>    cut_x <span class="op">=</span> keras.backend.cast(cut_x, <span class="st">"int32"</span>)</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>    cut_y <span class="op">=</span> keras.random.random.uniform((<span class="dv">1</span>,), minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span>IMG_SIZE)  <span class="co"># ry</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>    cut_y <span class="op">=</span> keras.backend.cast(cut_y, <span class="st">"int32"</span>)</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    boundaryx1 <span class="op">=</span> clip_by_value(cut_x[<span class="dv">0</span>] <span class="op">-</span> cut_w <span class="op">//</span> <span class="dv">2</span>, <span class="dv">0</span>, IMG_SIZE)</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>    boundaryy1 <span class="op">=</span> clip_by_value(cut_y[<span class="dv">0</span>] <span class="op">-</span> cut_h <span class="op">//</span> <span class="dv">2</span>, <span class="dv">0</span>, IMG_SIZE)</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>    bbx2 <span class="op">=</span> clip_by_value(cut_x[<span class="dv">0</span>] <span class="op">+</span> cut_w <span class="op">//</span> <span class="dv">2</span>, <span class="dv">0</span>, IMG_SIZE)</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>    bby2 <span class="op">=</span> clip_by_value(cut_y[<span class="dv">0</span>] <span class="op">+</span> cut_h <span class="op">//</span> <span class="dv">2</span>, <span class="dv">0</span>, IMG_SIZE)</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>    target_h <span class="op">=</span> bby2 <span class="op">-</span> boundaryy1</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>    <span class="cf">if</span> target_h <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>        target_h <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>    target_w <span class="op">=</span> bbx2 <span class="op">-</span> boundaryx1</span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>    <span class="cf">if</span> target_w <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>        target_w <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>    <span class="cf">return</span> boundaryx1, boundaryy1, target_h, target_w</span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a><span class="kw">def</span> cutmix(train_ds_one, train_ds_two):</span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>    (image1, label1), (image2, label2) <span class="op">=</span> train_ds_one, train_ds_two</span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>    alpha <span class="op">=</span> [<span class="fl">0.25</span>]</span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>    beta <span class="op">=</span> [<span class="fl">0.25</span>]</span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a>    <span class="co"># Get a sample from the Beta distribution</span></span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a>    lambda_value <span class="op">=</span> sample_beta_distribution(<span class="dv">1</span>, alpha, beta)</span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a>    <span class="co"># Define Lambda</span></span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>    lambda_value <span class="op">=</span> lambda_value[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>    <span class="co"># Get the bounding box offsets, heights and widths</span></span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a>    boundaryx1, boundaryy1, target_h, target_w <span class="op">=</span> get_box(lambda_value)</span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a></span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>    <span class="co"># Get a patch from the second image (`image2`)</span></span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a>    crop2 <span class="op">=</span> tf_image.crop_to_bounding_box(</span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a>        image2, boundaryy1, boundaryx1, target_h, target_w</span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a>    )</span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a>    <span class="co"># Pad the `image2` patch (`crop2`) with the same offset</span></span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a>    image2 <span class="op">=</span> tf_image.pad_to_bounding_box(</span>
<span id="cb6-58"><a href="#cb6-58" tabindex="-1"></a>        crop2, boundaryy1, boundaryx1, IMG_SIZE, IMG_SIZE</span>
<span id="cb6-59"><a href="#cb6-59" tabindex="-1"></a>    )</span>
<span id="cb6-60"><a href="#cb6-60" tabindex="-1"></a>    <span class="co"># Get a patch from the first image (`image1`)</span></span>
<span id="cb6-61"><a href="#cb6-61" tabindex="-1"></a>    crop1 <span class="op">=</span> tf_image.crop_to_bounding_box(</span>
<span id="cb6-62"><a href="#cb6-62" tabindex="-1"></a>        image1, boundaryy1, boundaryx1, target_h, target_w</span>
<span id="cb6-63"><a href="#cb6-63" tabindex="-1"></a>    )</span>
<span id="cb6-64"><a href="#cb6-64" tabindex="-1"></a>    <span class="co"># Pad the `image1` patch (`crop1`) with the same offset</span></span>
<span id="cb6-65"><a href="#cb6-65" tabindex="-1"></a>    img1 <span class="op">=</span> tf_image.pad_to_bounding_box(</span>
<span id="cb6-66"><a href="#cb6-66" tabindex="-1"></a>        crop1, boundaryy1, boundaryx1, IMG_SIZE, IMG_SIZE</span>
<span id="cb6-67"><a href="#cb6-67" tabindex="-1"></a>    )</span>
<span id="cb6-68"><a href="#cb6-68" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" tabindex="-1"></a>    <span class="co"># Modify the first image by subtracting the patch from `image1`</span></span>
<span id="cb6-70"><a href="#cb6-70" tabindex="-1"></a>    <span class="co"># (before applying the `image2` patch)</span></span>
<span id="cb6-71"><a href="#cb6-71" tabindex="-1"></a>    image1 <span class="op">=</span> image1 <span class="op">-</span> img1</span>
<span id="cb6-72"><a href="#cb6-72" tabindex="-1"></a>    <span class="co"># Add the modified `image1` and `image2`  together to get the CutMix image</span></span>
<span id="cb6-73"><a href="#cb6-73" tabindex="-1"></a>    image <span class="op">=</span> image1 <span class="op">+</span> image2</span>
<span id="cb6-74"><a href="#cb6-74" tabindex="-1"></a></span>
<span id="cb6-75"><a href="#cb6-75" tabindex="-1"></a>    <span class="co"># Adjust Lambda in accordance to the pixel ration</span></span>
<span id="cb6-76"><a href="#cb6-76" tabindex="-1"></a>    lambda_value <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> (target_w <span class="op">*</span> target_h) <span class="op">/</span> (IMG_SIZE <span class="op">*</span> IMG_SIZE)</span>
<span id="cb6-77"><a href="#cb6-77" tabindex="-1"></a>    lambda_value <span class="op">=</span> keras.backend.cast(lambda_value, <span class="st">"float32"</span>)</span>
<span id="cb6-78"><a href="#cb6-78" tabindex="-1"></a></span>
<span id="cb6-79"><a href="#cb6-79" tabindex="-1"></a>    <span class="co"># Combine the labels of both images</span></span>
<span id="cb6-80"><a href="#cb6-80" tabindex="-1"></a>    label <span class="op">=</span> lambda_value <span class="op">*</span> label1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> lambda_value) <span class="op">*</span> label2</span>
<span id="cb6-81"><a href="#cb6-81" tabindex="-1"></a>    <span class="cf">return</span> image, label</span></code></pre></div>
<p><strong>Note</strong>: we are combining two images to create a single
one.</p>
</div>
<div class="section level2">
<h2 id="visualize-the-new-dataset-after-applying-the-cutmix-augmentation">Visualize the new dataset after applying the CutMix
augmentation<a class="anchor" aria-label="anchor" href="#visualize-the-new-dataset-after-applying-the-cutmix-augmentation"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Create the new dataset using our `cutmix` utility</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>train_ds_cmu <span class="op">=</span> (</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    train_ds.shuffle(<span class="dv">1024</span>)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    .<span class="bu">map</span>(cutmix, num_parallel_calls<span class="op">=</span>AUTO)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>    .batch(BATCH_SIZE)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    .prefetch(AUTO)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co"># Let's preview 9 samples from the dataset</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>image_batch, label_batch <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_ds_cmu))</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>):</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>    ax <span class="op">=</span> plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>    plt.title(class_names[np.argmax(label_batch[i])])</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>    plt.imshow(image_batch[i])</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>    plt.axis(<span class="st">"off"</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-a-resnet-20-model">Define a ResNet-20 model<a class="anchor" aria-label="anchor" href="#define-a-resnet-20-model"></a>
</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">def</span> resnet_layer(</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    inputs,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    num_filters<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    strides<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    activation<span class="op">=</span><span class="st">"relu"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    batch_normalization<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    conv_first<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>):</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    conv <span class="op">=</span> layers.Conv2D(</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>        num_filters,</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>        kernel_size<span class="op">=</span>kernel_size,</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>        strides<span class="op">=</span>strides,</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>        padding<span class="op">=</span><span class="st">"same"</span>,</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>        kernel_initializer<span class="op">=</span><span class="st">"he_normal"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>        kernel_regularizer<span class="op">=</span>keras.regularizers.L2(<span class="fl">1e-4</span>),</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>    )</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>    x <span class="op">=</span> inputs</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>    <span class="cf">if</span> conv_first:</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>        x <span class="op">=</span> conv(x)</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>        <span class="cf">if</span> batch_normalization:</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>            x <span class="op">=</span> layers.BatchNormalization()(x)</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>        <span class="cf">if</span> activation <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>            x <span class="op">=</span> layers.Activation(activation)(x)</span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>        <span class="cf">if</span> batch_normalization:</span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a>            x <span class="op">=</span> layers.BatchNormalization()(x)</span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a>        <span class="cf">if</span> activation <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>            x <span class="op">=</span> layers.Activation(activation)(x)</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>        x <span class="op">=</span> conv(x)</span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a><span class="kw">def</span> resnet_v20(input_shape, depth, num_classes<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a>    <span class="cf">if</span> (depth <span class="op">-</span> <span class="dv">2</span>) <span class="op">%</span> <span class="dv">6</span> <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"depth should be 6n+2 (eg 20, 32, 44 in [a])"</span>)</span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a>    <span class="co"># Start model definition.</span></span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>    num_filters <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a>    num_res_blocks <span class="op">=</span> <span class="bu">int</span>((depth <span class="op">-</span> <span class="dv">2</span>) <span class="op">/</span> <span class="dv">6</span>)</span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a>    inputs <span class="op">=</span> layers.Input(shape<span class="op">=</span>input_shape)</span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a>    x <span class="op">=</span> resnet_layer(inputs<span class="op">=</span>inputs)</span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a>    <span class="co"># Instantiate the stack of residual units</span></span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a>    <span class="cf">for</span> stack <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a>        <span class="cf">for</span> res_block <span class="kw">in</span> <span class="bu">range</span>(num_res_blocks):</span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a>            strides <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb8-47"><a href="#cb8-47" tabindex="-1"></a>            <span class="cf">if</span> stack <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> res_block <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># first layer but not first stack</span></span>
<span id="cb8-48"><a href="#cb8-48" tabindex="-1"></a>                strides <span class="op">=</span> <span class="dv">2</span>  <span class="co"># downsample</span></span>
<span id="cb8-49"><a href="#cb8-49" tabindex="-1"></a>            y <span class="op">=</span> resnet_layer(inputs<span class="op">=</span>x, num_filters<span class="op">=</span>num_filters, strides<span class="op">=</span>strides)</span>
<span id="cb8-50"><a href="#cb8-50" tabindex="-1"></a>            y <span class="op">=</span> resnet_layer(inputs<span class="op">=</span>y, num_filters<span class="op">=</span>num_filters, activation<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb8-51"><a href="#cb8-51" tabindex="-1"></a>            <span class="cf">if</span> stack <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> res_block <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># first layer but not first stack</span></span>
<span id="cb8-52"><a href="#cb8-52" tabindex="-1"></a>                <span class="co"># linear projection residual shortcut connection to match</span></span>
<span id="cb8-53"><a href="#cb8-53" tabindex="-1"></a>                <span class="co"># changed dims</span></span>
<span id="cb8-54"><a href="#cb8-54" tabindex="-1"></a>                x <span class="op">=</span> resnet_layer(</span>
<span id="cb8-55"><a href="#cb8-55" tabindex="-1"></a>                    inputs<span class="op">=</span>x,</span>
<span id="cb8-56"><a href="#cb8-56" tabindex="-1"></a>                    num_filters<span class="op">=</span>num_filters,</span>
<span id="cb8-57"><a href="#cb8-57" tabindex="-1"></a>                    kernel_size<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb8-58"><a href="#cb8-58" tabindex="-1"></a>                    strides<span class="op">=</span>strides,</span>
<span id="cb8-59"><a href="#cb8-59" tabindex="-1"></a>                    activation<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb8-60"><a href="#cb8-60" tabindex="-1"></a>                    batch_normalization<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-61"><a href="#cb8-61" tabindex="-1"></a>                )</span>
<span id="cb8-62"><a href="#cb8-62" tabindex="-1"></a>            x <span class="op">=</span> layers.add([x, y])</span>
<span id="cb8-63"><a href="#cb8-63" tabindex="-1"></a>            x <span class="op">=</span> layers.Activation(<span class="st">"relu"</span>)(x)</span>
<span id="cb8-64"><a href="#cb8-64" tabindex="-1"></a>        num_filters <span class="op">*=</span> <span class="dv">2</span></span>
<span id="cb8-65"><a href="#cb8-65" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" tabindex="-1"></a>    <span class="co"># Add classifier on top.</span></span>
<span id="cb8-67"><a href="#cb8-67" tabindex="-1"></a>    <span class="co"># v1 does not use BN after last shortcut connection-ReLU</span></span>
<span id="cb8-68"><a href="#cb8-68" tabindex="-1"></a>    x <span class="op">=</span> layers.AveragePooling2D(pool_size<span class="op">=</span><span class="dv">8</span>)(x)</span>
<span id="cb8-69"><a href="#cb8-69" tabindex="-1"></a>    y <span class="op">=</span> layers.Flatten()(x)</span>
<span id="cb8-70"><a href="#cb8-70" tabindex="-1"></a>    outputs <span class="op">=</span> layers.Dense(</span>
<span id="cb8-71"><a href="#cb8-71" tabindex="-1"></a>        num_classes, activation<span class="op">=</span><span class="st">"softmax"</span>, kernel_initializer<span class="op">=</span><span class="st">"he_normal"</span></span>
<span id="cb8-72"><a href="#cb8-72" tabindex="-1"></a>    )(y)</span>
<span id="cb8-73"><a href="#cb8-73" tabindex="-1"></a></span>
<span id="cb8-74"><a href="#cb8-74" tabindex="-1"></a>    <span class="co"># Instantiate model.</span></span>
<span id="cb8-75"><a href="#cb8-75" tabindex="-1"></a>    model <span class="op">=</span> keras.Model(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs)</span>
<span id="cb8-76"><a href="#cb8-76" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb8-77"><a href="#cb8-77" tabindex="-1"></a></span>
<span id="cb8-78"><a href="#cb8-78" tabindex="-1"></a></span>
<span id="cb8-79"><a href="#cb8-79" tabindex="-1"></a><span class="kw">def</span> training_model():</span>
<span id="cb8-80"><a href="#cb8-80" tabindex="-1"></a>    <span class="cf">return</span> resnet_v20((<span class="dv">32</span>, <span class="dv">32</span>, <span class="dv">3</span>), <span class="dv">20</span>)</span>
<span id="cb8-81"><a href="#cb8-81" tabindex="-1"></a></span>
<span id="cb8-82"><a href="#cb8-82" tabindex="-1"></a></span>
<span id="cb8-83"><a href="#cb8-83" tabindex="-1"></a>initial_model <span class="op">=</span> training_model()</span>
<span id="cb8-84"><a href="#cb8-84" tabindex="-1"></a>initial_model.save_weights(<span class="st">"initial_weights.weights.h5"</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="train-the-model-with-the-dataset-augmented-by-cutmix">Train the model with the dataset augmented by CutMix<a class="anchor" aria-label="anchor" href="#train-the-model-with-the-dataset-augmented-by-cutmix"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>model <span class="op">=</span> training_model()</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>model.load_weights(<span class="st">"initial_weights.weights.h5"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>    loss<span class="op">=</span><span class="st">"categorical_crossentropy"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>, metrics<span class="op">=</span>[<span class="st">"accuracy"</span>]</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>)</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>model.fit(train_ds_cmu, validation_data<span class="op">=</span>test_ds, epochs<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>test_loss, test_accuracy <span class="op">=</span> model.evaluate(test_ds)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test accuracy: </span><span class="sc">{:.2f}</span><span class="st">%"</span>.<span class="bu">format</span>(test_accuracy <span class="op">*</span> <span class="dv">100</span>))</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="train-the-model-using-the-original-non-augmented-dataset">Train the model using the original non-augmented dataset<a class="anchor" aria-label="anchor" href="#train-the-model-using-the-original-non-augmented-dataset"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>model <span class="op">=</span> training_model()</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>model.load_weights(<span class="st">"initial_weights.weights.h5"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    loss<span class="op">=</span><span class="st">"categorical_crossentropy"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>, metrics<span class="op">=</span>[<span class="st">"accuracy"</span>]</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>model.fit(train_ds_simple, validation_data<span class="op">=</span>test_ds, epochs<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>test_loss, test_accuracy <span class="op">=</span> model.evaluate(test_ds)</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test accuracy: </span><span class="sc">{:.2f}</span><span class="st">%"</span>.<span class="bu">format</span>(test_accuracy <span class="op">*</span> <span class="dv">100</span>))</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a>
</h2>
<p>In this example, we trained our model for 15 epochs. In our
experiment, the model with CutMix achieves a better accuracy on the
CIFAR-10 dataset (77.34% in our experiment) compared to the model that
doesn’t use the augmentation (66.90%). You may notice it takes less time
to train the model with the CutMix augmentation.</p>
<p>You can experiment further with the CutMix technique by following the
<a href="https://arxiv.org/abs/1905.04899" class="external-link">original paper</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet, Posit Software, PBC, Google.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
