<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Classify tabular data in a few lines of code.">
<title>Structured data classification with FeatureSpace • keras3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Structured data classification with FeatureSpace">
<meta property="og:description" content="Classify tabular data in a few lines of code.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">keras3</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.13.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../index.html">Home</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-getting-started">Getting Started</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-getting-started">
    <a class="dropdown-item" href="../../articles/intro_to_keras_for_engineers.html">Introduction to Keras for engineers</a>
    <h6 class="dropdown-header" data-toc-skip>Tutorials</h6>
    <a class="dropdown-item" href="../../articles/getting_started.html">Getting Started</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_classification.html">Basic Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_text_classification.html">Text Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_regression.html">Basic Regression</a>
    <a class="dropdown-item" href="../../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    <a class="dropdown-item" href="../../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-guides">Guides</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-guides">
    <h6 class="dropdown-header" data-toc-skip>Model definition</h6>
    <a class="dropdown-item" href="../../articles/functional_api.html">Functional API</a>
    <a class="dropdown-item" href="../../articles/sequential_model.html">Sequential Model</a>
    <h6 class="dropdown-header" data-toc-skip>Extending and customizing</h6>
    <a class="dropdown-item" href="../../articles/making_new_layers_and_models_via_subclassing.html">Making new layers and models via subclassing</a>
    <a class="dropdown-item" href="../../articles/training_with_built_in_methods.html">Training &amp; evaluation with the built-in methods</a>
    <a class="dropdown-item" href="../../articles/writing_a_custom_training_loop_in_tensorflow.html">Writing a training loop from scratch in TensorFlow</a>
    <a class="dropdown-item" href="../../articles/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    <h6 class="dropdown-header" data-toc-skip>Other topics</h6>
    <a class="dropdown-item" href="../../articles/transfer_learning.html">Transfer learning and fine tuning</a>
    <a class="dropdown-item" href="../../articles/distributed_training_with_tensorflow.html">Distributed training with TensorFlow</a>
  </div>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../../articles/examples/index.html">Examples</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rstudio/keras/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Structured data classification with FeatureSpace</h1>
                        <h4 data-toc-skip class="author"><a href="https://twitter.com/fchollet" class="external-link">fchollet</a></h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/HEAD/vignettes/examples/structured_data_classification_with_feature_space.Rmd" class="external-link"><code>vignettes/examples/structured_data_classification_with_feature_space.Rmd</code></a></small>
      <div class="d-none name"><code>structured_data_classification_with_feature_space.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This example demonstrates how to do structured data classification
(also known as tabular data classification), starting from a raw CSV
file. Our data includes numerical features, and integer categorical
features, and string categorical features. We will use the utility
<code>keras.utils.FeatureSpace</code> to index, preprocess, and encode
our features.</p>
<p>The code is adapted from the example <a href="https://keras.io/examples/structured_data/structured_data_classification_from_scratch/" class="external-link">Structured
data classification from scratch</a>. While the previous example managed
its own low-level feature preprocessing and encoding with Keras
preprocessing layers, in this example we delegate everything to
<code>FeatureSpace</code>, making the workflow extremely quick and
easy.</p>
<p>Note that this example should be run with TensorFlow 2.12 or higher.
Before the release of TensorFlow 2.12, you can use
<code>tf-nightly</code>.</p>
<div class="section level3">
<h3 id="the-dataset">The dataset<a class="anchor" aria-label="anchor" href="#the-dataset"></a>
</h3>
<p><a href="https://archive.ics.uci.edu/ml/datasets/heart+Disease" class="external-link">Our
dataset</a> is provided by the Cleveland Clinic Foundation for Heart
Disease. It’s a CSV file with 303 rows. Each row contains information
about a patient (a <strong>sample</strong>), and each column describes
an attribute of the patient (a <strong>feature</strong>). We use the
features to predict whether a patient has a heart disease
(<strong>binary classification</strong>).</p>
<p>Here’s the description of each feature:</p>
<table class="table">
<colgroup>
<col width="22%">
<col width="37%">
<col width="40%">
</colgroup>
<thead><tr class="header">
<th>Column</th>
<th>Description</th>
<th>Feature Type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Age</td>
<td>Age in years</td>
<td>Numerical</td>
</tr>
<tr class="even">
<td>Sex</td>
<td>(1 = male; 0 = female)</td>
<td>Categorical</td>
</tr>
<tr class="odd">
<td>CP</td>
<td>Chest pain type (0, 1, 2, 3, 4)</td>
<td>Categorical</td>
</tr>
<tr class="even">
<td>Trestbpd</td>
<td>Resting blood pressure (in mm Hg on admission)</td>
<td>Numerical</td>
</tr>
<tr class="odd">
<td>Chol</td>
<td>Serum cholesterol in mg/dl</td>
<td>Numerical</td>
</tr>
<tr class="even">
<td>FBS</td>
<td>fasting blood sugar in 120 mg/dl (1 = true; 0 = false)</td>
<td>Categorical</td>
</tr>
<tr class="odd">
<td>RestECG</td>
<td>Resting electrocardiogram results (0, 1, 2)</td>
<td>Categorical</td>
</tr>
<tr class="even">
<td>Thalach</td>
<td>Maximum heart rate achieved</td>
<td>Numerical</td>
</tr>
<tr class="odd">
<td>Exang</td>
<td>Exercise induced angina (1 = yes; 0 = no)</td>
<td>Categorical</td>
</tr>
<tr class="even">
<td>Oldpeak</td>
<td>ST depression induced by exercise relative to rest</td>
<td>Numerical</td>
</tr>
<tr class="odd">
<td>Slope</td>
<td>Slope of the peak exercise ST segment</td>
<td>Numerical</td>
</tr>
<tr class="even">
<td>CA</td>
<td>Number of major vessels (0-3) colored by fluoroscopy</td>
<td>Both numerical &amp; categorical</td>
</tr>
<tr class="odd">
<td>Thal</td>
<td>3 = normal; 6 = fixed defect; 7 = reversible defect</td>
<td>Categorical</td>
</tr>
<tr class="even">
<td>Target</td>
<td>Diagnosis of heart disease (1 = true; 0 = false)</td>
<td>Target</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">import</span> keras <span class="im">as</span> keras</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> FeatureSpace</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>keras.config.disable_traceback_filtering()</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preparing-the-data">Preparing the data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h2>
<p>Let’s download the data and load it into a Pandas dataframe:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>file_url <span class="op">=</span> (</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    <span class="st">"http://storage.googleapis.com/download.tensorflow.org/data/heart.csv"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>dataframe <span class="op">=</span> pd.read_csv(file_url)</span></code></pre></div>
<p>The dataset includes 303 samples with 14 columns per sample (13
features, plus the target label):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="bu">print</span>(dataframe.shape)</span></code></pre></div>
<p>Here’s a preview of a few samples:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>dataframe.head()</span></code></pre></div>
<p>The last column, “target”, indicates whether the patient has a heart
disease (1) or not (0).</p>
<p>Let’s split the data into a training and validation set:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>val_dataframe <span class="op">=</span> dataframe.sample(frac<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">1337</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>train_dataframe <span class="op">=</span> dataframe.drop(val_dataframe.index)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    <span class="st">"Using </span><span class="sc">%d</span><span class="st"> samples for training and </span><span class="sc">%d</span><span class="st"> for validation"</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    <span class="op">%</span> (<span class="bu">len</span>(train_dataframe), <span class="bu">len</span>(val_dataframe))</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>)</span></code></pre></div>
<p>Let’s generate <code>tf.data.Dataset</code> objects for each
dataframe:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">def</span> dataframe_to_dataset(dataframe):</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>    dataframe <span class="op">=</span> dataframe.copy()</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    labels <span class="op">=</span> dataframe.pop(<span class="st">"target"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    ds <span class="op">=</span> tf.data.Dataset.from_tensor_slices((<span class="bu">dict</span>(dataframe), labels))</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    ds <span class="op">=</span> ds.shuffle(buffer_size<span class="op">=</span><span class="bu">len</span>(dataframe))</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    <span class="cf">return</span> ds</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>train_ds <span class="op">=</span> dataframe_to_dataset(train_dataframe)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>val_ds <span class="op">=</span> dataframe_to_dataset(val_dataframe)</span></code></pre></div>
<p>Each <code>Dataset</code> yields a tuple <code>(input, target)</code>
where <code>input</code> is a dictionary of features and
<code>target</code> is the value <code>0</code> or <code>1</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="cf">for</span> x, y <span class="kw">in</span> train_ds.take(<span class="dv">1</span>):</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Input:"</span>, x)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Target:"</span>, y)</span></code></pre></div>
<p>Let’s batch the datasets:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>train_ds <span class="op">=</span> train_ds.batch(<span class="dv">32</span>)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>val_ds <span class="op">=</span> val_ds.batch(<span class="dv">32</span>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="configuring-a-featurespace">Configuring a <code>FeatureSpace</code><a class="anchor" aria-label="anchor" href="#configuring-a-featurespace"></a>
</h2>
<p>To configure how each feature should be preprocessed, we instantiate
a <code>keras.utils.FeatureSpace</code>, and we pass to it a dictionary
that maps the name of our features to a string that describes the
feature type.</p>
<p>We have a few “integer categorical” features such as
<code>"FBS"</code>, one “string categorical” feature
(<code>"thal"</code>), and a few numerical features, which we’d like to
normalize – except <code>"age"</code>, which we’d like to discretize
into a number of bins.</p>
<p>We also use the <code>crosses</code> argument to capture <em>feature
interactions</em> for some categorical features, that is to say, create
additional features that represent value co-occurrences for these
categorical features. You can compute feature crosses like this for
arbitrary sets of categorical features – not just tuples of two
features. Because the resulting co-occurences are hashed into a
fixed-sized vector, you don’t need to worry about whether the
co-occurence space is too large.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>feature_space <span class="op">=</span> FeatureSpace(</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    features<span class="op">=</span>{</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>        <span class="co"># Categorical features encoded as integers</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>        <span class="st">"sex"</span>: <span class="st">"integer_categorical"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>        <span class="st">"cp"</span>: <span class="st">"integer_categorical"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>        <span class="st">"fbs"</span>: <span class="st">"integer_categorical"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>        <span class="st">"restecg"</span>: <span class="st">"integer_categorical"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>        <span class="st">"exang"</span>: <span class="st">"integer_categorical"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>        <span class="st">"ca"</span>: <span class="st">"integer_categorical"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>        <span class="co"># Categorical feature encoded as string</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>        <span class="st">"thal"</span>: <span class="st">"string_categorical"</span>,</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>        <span class="co"># Numerical features to discretize</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>        <span class="st">"age"</span>: <span class="st">"float_discretized"</span>,</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>        <span class="co"># Numerical features to normalize</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>        <span class="st">"trestbps"</span>: <span class="st">"float_normalized"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>        <span class="st">"chol"</span>: <span class="st">"float_normalized"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>        <span class="st">"thalach"</span>: <span class="st">"float_normalized"</span>,</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>        <span class="st">"oldpeak"</span>: <span class="st">"float_normalized"</span>,</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>        <span class="st">"slope"</span>: <span class="st">"float_normalized"</span>,</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>    },</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    <span class="co"># We create additional features by hashing</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>    <span class="co"># value co-occurrences for the</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>    <span class="co"># following groups of categorical features.</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>    crosses<span class="op">=</span>[(<span class="st">"sex"</span>, <span class="st">"age"</span>), (<span class="st">"thal"</span>, <span class="st">"ca"</span>)],</span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>    <span class="co"># The hashing space for these co-occurrences</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>    <span class="co"># wil be 32-dimensional.</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>    crossing_dim<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>    <span class="co"># Our utility will one-hot encode all categorical</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>    <span class="co"># features and concat all features into a single</span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>    <span class="co"># vector (one vector per sample).</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>    output_mode<span class="op">=</span><span class="st">"concat"</span>,</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="further-customizing-a-featurespace">Further customizing a <code>FeatureSpace</code><a class="anchor" aria-label="anchor" href="#further-customizing-a-featurespace"></a>
</h2>
<p>Specifying the feature type via a string name is quick and easy, but
sometimes you may want to further configure the preprocessing of each
feature. For instance, in our case, our categorical features don’t have
a large set of possible values – it’s only a handful of values per
feature (e.g. <code>1</code> and <code>0</code> for the feature
<code>"FBS"</code>), and all possible values are represented in the
training set. As a result, we don’t need to reserve an index to
represent “out of vocabulary” values for these features – which would
have been the default behavior. Below, we just specify
<code>num_oov_indices=0</code> in each of these features to tell the
feature preprocessor to skip “out of vocabulary” indexing.</p>
<p>Other customizations you have access to include specifying the number
of bins for discretizing features of type
<code>"float_discretized"</code>, or the dimensionality of the hashing
space for feature crossing.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>feature_space <span class="op">=</span> FeatureSpace(</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    features<span class="op">=</span>{</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>        <span class="co"># Categorical features encoded as integers</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>        <span class="st">"sex"</span>: FeatureSpace.integer_categorical(num_oov_indices<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>        <span class="st">"cp"</span>: FeatureSpace.integer_categorical(num_oov_indices<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>        <span class="st">"fbs"</span>: FeatureSpace.integer_categorical(num_oov_indices<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>        <span class="st">"restecg"</span>: FeatureSpace.integer_categorical(num_oov_indices<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>        <span class="st">"exang"</span>: FeatureSpace.integer_categorical(num_oov_indices<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>        <span class="st">"ca"</span>: FeatureSpace.integer_categorical(num_oov_indices<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>        <span class="co"># Categorical feature encoded as string</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>        <span class="st">"thal"</span>: FeatureSpace.string_categorical(num_oov_indices<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>        <span class="co"># Numerical features to discretize</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>        <span class="st">"age"</span>: FeatureSpace.float_discretized(num_bins<span class="op">=</span><span class="dv">30</span>),</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>        <span class="co"># Numerical features to normalize</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>        <span class="st">"trestbps"</span>: FeatureSpace.float_normalized(),</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>        <span class="st">"chol"</span>: FeatureSpace.float_normalized(),</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>        <span class="st">"thalach"</span>: FeatureSpace.float_normalized(),</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>        <span class="st">"oldpeak"</span>: FeatureSpace.float_normalized(),</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>        <span class="st">"slope"</span>: FeatureSpace.float_normalized(),</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>    },</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>    <span class="co"># Specify feature cross with a custom crossing dim.</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>    crosses<span class="op">=</span>[</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>        FeatureSpace.cross(feature_names<span class="op">=</span>(<span class="st">"sex"</span>, <span class="st">"age"</span>), crossing_dim<span class="op">=</span><span class="dv">64</span>),</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>        FeatureSpace.cross(</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>            feature_names<span class="op">=</span>(<span class="st">"thal"</span>, <span class="st">"ca"</span>),</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>            crossing_dim<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>        ),</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>    ],</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>    output_mode<span class="op">=</span><span class="st">"concat"</span>,</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="adapt-the-featurespace-to-the-training-data">Adapt the <code>FeatureSpace</code> to the training data<a class="anchor" aria-label="anchor" href="#adapt-the-featurespace-to-the-training-data"></a>
</h2>
<p>Before we start using the <code>FeatureSpace</code> to build a model,
we have to adapt it to the training data. During <code><a href="../../reference/adapt.html">adapt()</a></code>,
the <code>FeatureSpace</code> will:</p>
<ul>
<li>Index the set of possible values for categorical features.</li>
<li>Compute the mean and variance for numerical features to
normalize.</li>
<li>Compute the value boundaries for the different bins for numerical
features to discretize.</li>
</ul>
<p>Note that <code><a href="../../reference/adapt.html">adapt()</a></code> should be called on a
<code>tf.data.Dataset</code> which yields dicts of feature values – no
labels.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>train_ds_with_no_labels <span class="op">=</span> train_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, _: x)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>feature_space.adapt(train_ds_with_no_labels)</span></code></pre></div>
<p>At this point, the <code>FeatureSpace</code> can be called on a dict
of raw feature values, and will return a single concatenate vector for
each sample, combining encoded features and feature crosses.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="cf">for</span> x, _ <span class="kw">in</span> train_ds.take(<span class="dv">1</span>):</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>    preprocessed_x <span class="op">=</span> feature_space(x)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"preprocessed_x.shape:"</span>, preprocessed_x.shape)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"preprocessed_x.dtype:"</span>, preprocessed_x.dtype)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="two-ways-to-manage-preprocessing-as-part-of-the-tf-data-pipeline-or-in-the-model-itself">Two ways to manage preprocessing: as part of the
<code>tf.data</code> pipeline, or in the model itself<a class="anchor" aria-label="anchor" href="#two-ways-to-manage-preprocessing-as-part-of-the-tf-data-pipeline-or-in-the-model-itself"></a>
</h2>
<p>There are two ways in which you can leverage your
<code>FeatureSpace</code>:</p>
<div class="section level3">
<h3 id="asynchronous-preprocessing-in-tf-data">Asynchronous preprocessing in <code>tf.data</code><a class="anchor" aria-label="anchor" href="#asynchronous-preprocessing-in-tf-data"></a>
</h3>
<p>You can make it part of your data pipeline, before the model. This
enables asynchronous parallel preprocessing of the data on CPU before it
hits the model. Do this if you’re training on GPU or TPU, or if you want
to speed up preprocessing. Usually, this is always the right thing to do
during training.</p>
</div>
<div class="section level3">
<h3 id="synchronous-preprocessing-in-the-model">Synchronous preprocessing in the model<a class="anchor" aria-label="anchor" href="#synchronous-preprocessing-in-the-model"></a>
</h3>
<p>You can make it part of your model. This means that the model will
expect dicts of raw feature values, and the preprocessing batch will be
done synchronously (in a blocking manner) before the rest of the forward
pass. Do this if you want to have an end-to-end model that can process
raw feature values – but keep in mind that your model will only be able
to run on CPU, since most types of feature preprocessing (e.g. string
preprocessing) are not GPU or TPU compatible.</p>
<p>Do not do this on GPU / TPU or in performance-sensitive settings. In
general, you want to do in-model preprocessing when you do inference on
CPU.</p>
<p>In our case, we will apply the <code>FeatureSpace</code> in the
tf.data pipeline during training, but we will do inference with an
end-to-end model that includes the <code>FeatureSpace</code>.</p>
<p>Let’s create a training and validation dataset of preprocessed
batches:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>preprocessed_train_ds <span class="op">=</span> train_ds.<span class="bu">map</span>(</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>    <span class="kw">lambda</span> x, y: (feature_space(x), y), num_parallel_calls<span class="op">=</span>tf.data.AUTOTUNE</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>preprocessed_train_ds <span class="op">=</span> preprocessed_train_ds.prefetch(tf.data.AUTOTUNE)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>preprocessed_val_ds <span class="op">=</span> val_ds.<span class="bu">map</span>(</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    <span class="kw">lambda</span> x, y: (feature_space(x), y), num_parallel_calls<span class="op">=</span>tf.data.AUTOTUNE</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>)</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>preprocessed_val_ds <span class="op">=</span> preprocessed_val_ds.prefetch(tf.data.AUTOTUNE)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="build-a-model">Build a model<a class="anchor" aria-label="anchor" href="#build-a-model"></a>
</h2>
<p>Time to build a model – or rather two models:</p>
<ul>
<li>A training model that expects preprocessed features (one sample =
one vector)</li>
<li>An inference model that expects raw features (one sample = dict of
raw feature values)</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>dict_inputs <span class="op">=</span> feature_space.get_inputs()</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>encoded_features <span class="op">=</span> feature_space.get_encoded_features()</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dense(<span class="dv">32</span>, activation<span class="op">=</span><span class="st">"relu"</span>)(encoded_features)</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.5</span>)(x)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>predictions <span class="op">=</span> keras.layers.Dense(<span class="dv">1</span>, activation<span class="op">=</span><span class="st">"sigmoid"</span>)(x)</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>training_model <span class="op">=</span> keras.Model(inputs<span class="op">=</span>encoded_features, outputs<span class="op">=</span>predictions)</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>training_model.<span class="bu">compile</span>(</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>    optimizer<span class="op">=</span><span class="st">"adam"</span>, loss<span class="op">=</span><span class="st">"binary_crossentropy"</span>, metrics<span class="op">=</span>[<span class="st">"accuracy"</span>]</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>)</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>inference_model <span class="op">=</span> keras.Model(inputs<span class="op">=</span>dict_inputs, outputs<span class="op">=</span>predictions)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="train-the-model">Train the model<a class="anchor" aria-label="anchor" href="#train-the-model"></a>
</h2>
<p>Let’s train our model for 50 epochs. Note that feature preprocessing
is happening as part of the tf.data pipeline, not as part of the
model.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>training_model.fit(</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    preprocessed_train_ds,</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>    epochs<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    validation_data<span class="op">=</span>preprocessed_val_ds,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>)</span></code></pre></div>
<p>We quickly get to 80% validation accuracy.</p>
</div>
<div class="section level2">
<h2 id="inference-on-new-data-with-the-end-to-end-model">Inference on new data with the end-to-end model<a class="anchor" aria-label="anchor" href="#inference-on-new-data-with-the-end-to-end-model"></a>
</h2>
<p>Now, we can use our inference model (which includes the
<code>FeatureSpace</code>) to make predictions based on dicts of raw
features values, as follows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>sample <span class="op">=</span> {</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="dv">60</span>,</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    <span class="st">"sex"</span>: <span class="dv">1</span>,</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    <span class="st">"cp"</span>: <span class="dv">1</span>,</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    <span class="st">"trestbps"</span>: <span class="dv">145</span>,</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    <span class="st">"chol"</span>: <span class="dv">233</span>,</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>    <span class="st">"fbs"</span>: <span class="dv">1</span>,</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>    <span class="st">"restecg"</span>: <span class="dv">2</span>,</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>    <span class="st">"thalach"</span>: <span class="dv">150</span>,</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>    <span class="st">"exang"</span>: <span class="dv">0</span>,</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>    <span class="st">"oldpeak"</span>: <span class="fl">2.3</span>,</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>    <span class="st">"slope"</span>: <span class="dv">3</span>,</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>    <span class="st">"ca"</span>: <span class="dv">0</span>,</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>    <span class="st">"thal"</span>: <span class="st">"fixed"</span>,</span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>}</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>input_dict <span class="op">=</span> {</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>    name: tf.convert_to_tensor([value]) <span class="cf">for</span> name, value <span class="kw">in</span> sample.items()</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>}</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>predictions <span class="op">=</span> inference_model.predict(input_dict)</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>    <span class="ss">f"This particular patient had a </span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> predictions[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">:.2f}</span><span class="ss">% probability "</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>    <span class="st">"of having a heart disease, as evaluated by our model."</span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>)</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet, Posit Software, PBC, Google.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
