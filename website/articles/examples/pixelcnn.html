<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="PixelCNN implemented in Keras.">
<title>PixelCNN â€¢ keras3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="PixelCNN">
<meta property="og:description" content="PixelCNN implemented in Keras.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">keras3</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.13.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../index.html">Home</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-getting-started">Getting Started</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-getting-started">
    <a class="dropdown-item" href="../../articles/intro_to_keras_for_engineers.html">Introduction to Keras for engineers</a>
    <h6 class="dropdown-header" data-toc-skip>Tutorials</h6>
    <a class="dropdown-item" href="../../articles/getting_started.html">Getting Started</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_classification.html">Basic Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_text_classification.html">Text Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_regression.html">Basic Regression</a>
    <a class="dropdown-item" href="../../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    <a class="dropdown-item" href="../../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-guides">Guides</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-guides">
    <h6 class="dropdown-header" data-toc-skip>Model definition</h6>
    <a class="dropdown-item" href="../../articles/functional_api.html">Functional API</a>
    <a class="dropdown-item" href="../../articles/sequential_model.html">Sequential Model</a>
    <h6 class="dropdown-header" data-toc-skip>Extending and customizing</h6>
    <a class="dropdown-item" href="../../articles/making_new_layers_and_models_via_subclassing.html">Making new layers and models via subclassing</a>
    <a class="dropdown-item" href="../../articles/training_with_built_in_methods.html">Training &amp; evaluation with the built-in methods</a>
    <a class="dropdown-item" href="../../articles/writing_a_custom_training_loop_in_tensorflow.html">Writing a training loop from scratch in TensorFlow</a>
    <a class="dropdown-item" href="../../articles/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    <h6 class="dropdown-header" data-toc-skip>Other topics</h6>
    <a class="dropdown-item" href="../../articles/transfer_learning.html">Transfer learning and fine tuning</a>
    <a class="dropdown-item" href="../../articles/distributed_training_with_tensorflow.html">Distributed training with TensorFlow</a>
  </div>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../../articles/examples/index.html">Examples</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rstudio/keras/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>PixelCNN</h1>
                        <h4 data-toc-skip class="author"><a href="https://github.com/ADMoreau" class="external-link">ADMoreau</a></h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/HEAD/vignettes/examples/pixelcnn.Rmd" class="external-link"><code>vignettes/examples/pixelcnn.Rmd</code></a></small>
      <div class="d-none name"><code>pixelcnn.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>PixelCNN is a generative model proposed in 2016 by van den Oord et
al. (reference: <a href="https://arxiv.org/abs/1606.05328" class="external-link">Conditional
Image Generation with PixelCNN Decoders</a>). It is designed to generate
images (or other data types) iteratively from an input vector where the
probability distribution of prior elements dictates the probability
distribution of later elements. In the following example, images are
generated in this fashion, pixel-by-pixel, via a masked convolution
kernel that only looks at data from previously generated pixels (origin
at the top left) to generate later pixels. During inference, the output
of the network is used as a probability ditribution from which new pixel
values are sampled to generate a new image (here, with MNIST, the pixels
values are either black or white).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> keras</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> layers</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> ops</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="getting-the-data">Getting the Data<a class="anchor" aria-label="anchor" href="#getting-the-data"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Model / data parameters</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>input_shape <span class="op">=</span> (<span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>n_residual_blocks <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co"># The data, split between train and test sets</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>(x, _), (y, _) <span class="op">=</span> keras.datasets.mnist.load_data()</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co"># Concatenate all the images together</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>data <span class="op">=</span> np.concatenate((x, y), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co"># Round all pixel values less than 33% of the max 256 value to 0</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co"># anything above this value gets rounded up to 1 so that all values are either</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="co"># 0 or 1</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>data <span class="op">=</span> np.where(data <span class="op">&lt;</span> (<span class="fl">0.33</span> <span class="op">*</span> <span class="dv">256</span>), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>data <span class="op">=</span> data.astype(np.float32)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-two-classes-for-the-requisite-layers-for-the-model">Create two classes for the requisite Layers for the model<a class="anchor" aria-label="anchor" href="#create-two-classes-for-the-requisite-layers-for-the-model"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># The first layer is the PixelCNN layer. This layer simply</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co"># builds on the 2D convolutional layer, but includes masking.</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="kw">class</span> PixelConvLayer(layers.Layer):</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, mask_type, <span class="op">**</span>kwargs):</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>        <span class="va">self</span>.mask_type <span class="op">=</span> mask_type</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>        <span class="va">self</span>.conv <span class="op">=</span> layers.Conv2D(<span class="op">**</span>kwargs)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>    <span class="kw">def</span> build(<span class="va">self</span>, input_shape):</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>        <span class="co"># Build the conv2d layer to initialize kernel variables</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>        <span class="va">self</span>.conv.build(input_shape)</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>        <span class="co"># Use the initialized kernel to create the mask</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>        kernel_shape <span class="op">=</span> ops.shape(<span class="va">self</span>.conv.kernel)</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>        <span class="va">self</span>.mask <span class="op">=</span> np.zeros(shape<span class="op">=</span>kernel_shape)</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>        <span class="va">self</span>.mask[: kernel_shape[<span class="dv">0</span>] <span class="op">//</span> <span class="dv">2</span>, ...] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>        <span class="va">self</span>.mask[kernel_shape[<span class="dv">0</span>] <span class="op">//</span> <span class="dv">2</span>, : kernel_shape[<span class="dv">1</span>] <span class="op">//</span> <span class="dv">2</span>, ...] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.mask_type <span class="op">==</span> <span class="st">"B"</span>:</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>            <span class="va">self</span>.mask[kernel_shape[<span class="dv">0</span>] <span class="op">//</span> <span class="dv">2</span>, kernel_shape[<span class="dv">1</span>] <span class="op">//</span> <span class="dv">2</span>, ...] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>        <span class="va">self</span>.conv.kernel.assign(<span class="va">self</span>.conv.kernel <span class="op">*</span> <span class="va">self</span>.mask)</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.conv(inputs)</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a><span class="co"># Next, we build our residual block layer.</span></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co"># This is just a normal residual block, but based on the PixelConvLayer.</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="kw">class</span> ResidualBlock(keras.layers.Layer):</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, filters, <span class="op">**</span>kwargs):</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>        <span class="va">self</span>.conv1 <span class="op">=</span> keras.layers.Conv2D(</span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>            filters<span class="op">=</span>filters, kernel_size<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span><span class="st">"relu"</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>        )</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>        <span class="va">self</span>.pixel_conv <span class="op">=</span> PixelConvLayer(</span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>            mask_type<span class="op">=</span><span class="st">"B"</span>,</span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>            filters<span class="op">=</span>filters <span class="op">//</span> <span class="dv">2</span>,</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">"relu"</span>,</span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a>            padding<span class="op">=</span><span class="st">"same"</span>,</span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>        )</span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>        <span class="va">self</span>.conv2 <span class="op">=</span> keras.layers.Conv2D(</span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>            filters<span class="op">=</span>filters, kernel_size<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span><span class="st">"relu"</span></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>        )</span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv1(inputs)</span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.pixel_conv(x)</span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv2(x)</span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>        <span class="cf">return</span> keras.layers.add([inputs, x])</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="build-the-model-based-on-the-original-paper">Build the model based on the original paper<a class="anchor" aria-label="anchor" href="#build-the-model-based-on-the-original-paper"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>inputs <span class="op">=</span> keras.Input(shape<span class="op">=</span>input_shape)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>x <span class="op">=</span> PixelConvLayer(</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    mask_type<span class="op">=</span><span class="st">"A"</span>, filters<span class="op">=</span><span class="dv">128</span>, kernel_size<span class="op">=</span><span class="dv">7</span>, activation<span class="op">=</span><span class="st">"relu"</span>, padding<span class="op">=</span><span class="st">"same"</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>)(inputs)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_residual_blocks):</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    x <span class="op">=</span> ResidualBlock(filters<span class="op">=</span><span class="dv">128</span>)(x)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    x <span class="op">=</span> PixelConvLayer(</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>        mask_type<span class="op">=</span><span class="st">"B"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>        filters<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>        kernel_size<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>        strides<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>        activation<span class="op">=</span><span class="st">"relu"</span>,</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>        padding<span class="op">=</span><span class="st">"valid"</span>,</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>    )(x)</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>out <span class="op">=</span> keras.layers.Conv2D(</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>    filters<span class="op">=</span><span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">1</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span><span class="st">"sigmoid"</span>, padding<span class="op">=</span><span class="st">"valid"</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>)(x)</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>pixel_cnn <span class="op">=</span> keras.Model(inputs, out)</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>adam <span class="op">=</span> keras.optimizers.Adam(learning_rate<span class="op">=</span><span class="fl">0.0005</span>)</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>pixel_cnn.<span class="bu">compile</span>(optimizer<span class="op">=</span>adam, loss<span class="op">=</span><span class="st">"binary_crossentropy"</span>)</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>pixel_cnn.summary()</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>pixel_cnn.fit(</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>    x<span class="op">=</span>data, y<span class="op">=</span>data, batch_size<span class="op">=</span><span class="dv">128</span>, epochs<span class="op">=</span><span class="dv">50</span>, validation_split<span class="op">=</span><span class="fl">0.1</span>, verbose<span class="op">=</span><span class="dv">2</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="demonstration">Demonstration<a class="anchor" aria-label="anchor" href="#demonstration"></a>
</h2>
<p>The PixelCNN cannot generate the full image at once. Instead, it must
generate each pixel in order, append the last generated pixel to the
current image, and feed the image back into the model to repeat the
process.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image, display</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co"># Create an empty array of pixels.</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>batch <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>pixels <span class="op">=</span> np.zeros(shape<span class="op">=</span>(batch,) <span class="op">+</span> (pixel_cnn.input_shape)[<span class="dv">1</span>:])</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>batch, rows, cols, channels <span class="op">=</span> pixels.shape</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co"># Iterate over the pixels because generation has to be done sequentially pixel by pixel.</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> tqdm(<span class="bu">range</span>(rows)):</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> <span class="bu">range</span>(cols):</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>        <span class="cf">for</span> channel <span class="kw">in</span> <span class="bu">range</span>(channels):</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>            <span class="co"># Feed the whole array and retrieving the pixel value probabilities for the next</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>            <span class="co"># pixel.</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>            probs <span class="op">=</span> pixel_cnn.predict(pixels)[:, row, col, channel]</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>            <span class="co"># Use the probabilities to pick pixel values and append the values to the image</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>            <span class="co"># frame.</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>            pixels[:, row, col, channel] <span class="op">=</span> ops.ceil(</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>                probs <span class="op">-</span> keras.random.uniform(probs.shape)</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>            )</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a><span class="kw">def</span> deprocess_image(x):</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>    <span class="co"># Stack the single channeled black and white image to rgb values.</span></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>    x <span class="op">=</span> np.stack((x, x, x), <span class="dv">2</span>)</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>    <span class="co"># Undo preprocessing</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>    x <span class="op">*=</span> <span class="fl">255.0</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>    <span class="co"># Convert to uint8 and clip to the valid range [0, 255]</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>    x <span class="op">=</span> np.clip(x, <span class="dv">0</span>, <span class="dv">255</span>).astype(<span class="st">"uint8"</span>)</span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a><span class="co"># Iterate over the generated images and plot them with matplotlib.</span></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a><span class="cf">for</span> i, pic <span class="kw">in</span> <span class="bu">enumerate</span>(pixels):</span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>    keras.utils.save_img(</span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>        <span class="st">"generated_image_</span><span class="sc">{}</span><span class="st">.png"</span>.<span class="bu">format</span>(i), deprocess_image(np.squeeze(pic, <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>    )</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>display(Image(<span class="st">"generated_image_0.png"</span>))</span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>display(Image(<span class="st">"generated_image_1.png"</span>))</span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a>display(Image(<span class="st">"generated_image_2.png"</span>))</span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>display(Image(<span class="st">"generated_image_3.png"</span>))</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tomasz Kalinowski, JJ Allaire, FranÃ§ois Chollet, Posit Software, PBC, Google.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
