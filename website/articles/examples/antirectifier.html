<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Demonstration of custom layer creation.">
<title>Simple custom layer example: Antirectifier â€¢ keras3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Simple custom layer example: Antirectifier">
<meta property="og:description" content="Demonstration of custom layer creation.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">keras3</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.13.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../index.html">Home</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-getting-started">Getting Started</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-getting-started">
    <a class="dropdown-item" href="../../articles/intro_to_keras_for_engineers.html">Introduction to Keras for engineers</a>
    <h6 class="dropdown-header" data-toc-skip>Tutorials</h6>
    <a class="dropdown-item" href="../../articles/getting_started.html">Getting Started</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_classification.html">Basic Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_text_classification.html">Text Classification</a>
    <a class="dropdown-item" href="../../articles/tutorial_basic_regression.html">Basic Regression</a>
    <a class="dropdown-item" href="../../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    <a class="dropdown-item" href="../../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-guides">Guides</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-guides">
    <h6 class="dropdown-header" data-toc-skip>Model definition</h6>
    <a class="dropdown-item" href="../../articles/functional_api.html">Functional API</a>
    <a class="dropdown-item" href="../../articles/sequential_model.html">Sequential Model</a>
    <h6 class="dropdown-header" data-toc-skip>Extending and customizing</h6>
    <a class="dropdown-item" href="../../articles/making_new_layers_and_models_via_subclassing.html">Making new layers and models via subclassing</a>
    <a class="dropdown-item" href="../../articles/training_with_built_in_methods.html">Training &amp; evaluation with the built-in methods</a>
    <a class="dropdown-item" href="../../articles/writing_a_custom_training_loop_in_tensorflow.html">Writing a training loop from scratch in TensorFlow</a>
    <a class="dropdown-item" href="../../articles/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    <h6 class="dropdown-header" data-toc-skip>Other topics</h6>
    <a class="dropdown-item" href="../../articles/transfer_learning.html">Transfer learning and fine tuning</a>
    <a class="dropdown-item" href="../../articles/distributed_training_with_tensorflow.html">Distributed training with TensorFlow</a>
  </div>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../../articles/examples/index.html">Examples</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rstudio/keras/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Simple custom layer example: Antirectifier</h1>
                        <h4 data-toc-skip class="author"><a href="https://twitter.com/fchollet" class="external-link">fchollet</a></h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/HEAD/vignettes/examples/antirectifier.Rmd" class="external-link"><code>vignettes/examples/antirectifier.Rmd</code></a></small>
      <div class="d-none name"><code>antirectifier.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This example shows how to create custom layers, using the
Antirectifier layer (originally proposed as a Keras example script in
January 2016), an alternative to ReLU. Instead of zeroing-out the
negative part of the input, it splits the negative and positive parts
and returns the concatenation of the absolute value of both. This avoids
loss of information, at the cost of an increase in dimensionality. To
fix the dimensionality increase, we linearly combine the features back
to a space of the original size.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> keras <span class="im">as</span> keras</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> layers</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-antirectifier-layer">The Antirectifier layer<a class="anchor" aria-label="anchor" href="#the-antirectifier-layer"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">class</span> Antirectifier(layers.Layer):</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, initializer<span class="op">=</span><span class="st">"he_normal"</span>, <span class="op">**</span>kwargs):</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>        <span class="va">self</span>.initializer <span class="op">=</span> keras.initializers.get(initializer)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>    <span class="kw">def</span> build(<span class="va">self</span>, input_shape):</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>        output_dim <span class="op">=</span> input_shape[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>        <span class="va">self</span>.kernel <span class="op">=</span> <span class="va">self</span>.add_weight(</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>            shape<span class="op">=</span>(output_dim <span class="op">*</span> <span class="dv">2</span>, output_dim),</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>            initializer<span class="op">=</span><span class="va">self</span>.initializer,</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"kernel"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>            trainable<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>        )</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>        inputs <span class="op">-=</span> tf.reduce_mean(inputs, axis<span class="op">=-</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>        pos <span class="op">=</span> tf.nn.relu(inputs)</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>        neg <span class="op">=</span> tf.nn.relu(<span class="op">-</span>inputs)</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>        concatenated <span class="op">=</span> tf.concat([pos, neg], axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>        mixed <span class="op">=</span> tf.matmul(concatenated, <span class="va">self</span>.kernel)</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>        <span class="cf">return</span> mixed</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>        <span class="co"># Implement get_config to enable serialization. This is optional.</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>        base_config <span class="op">=</span> <span class="bu">super</span>().get_config()</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>        config <span class="op">=</span> {<span class="st">"initializer"</span>: keras.initializers.serialize(<span class="va">self</span>.initializer)}</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">list</span>(base_config.items()) <span class="op">+</span> <span class="bu">list</span>(config.items()))</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="lets-test-drive-it-on-mnist">Letâ€™s test-drive it on MNIST<a class="anchor" aria-label="anchor" href="#lets-test-drive-it-on-mnist"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Training parameters</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co"># The data, split between train and test sets</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>(x_train, y_train), (x_test, y_test) <span class="op">=</span> keras.datasets.mnist.load_data()</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>x_train <span class="op">=</span> x_train.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">784</span>)</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>x_test <span class="op">=</span> x_test.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">784</span>)</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>x_train <span class="op">=</span> x_train.astype(<span class="st">"float32"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>x_test <span class="op">=</span> x_test.astype(<span class="st">"float32"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>x_train <span class="op">/=</span> <span class="dv">255</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>x_test <span class="op">/=</span> <span class="dv">255</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="bu">print</span>(x_train.shape[<span class="dv">0</span>], <span class="st">"train samples"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="bu">print</span>(x_test.shape[<span class="dv">0</span>], <span class="st">"test samples"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>model <span class="op">=</span> keras.Sequential(</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>    [</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>        keras.Input(shape<span class="op">=</span>(<span class="dv">784</span>,)),</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>        layers.Dense(<span class="dv">256</span>),</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>        Antirectifier(),</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>        layers.Dense(<span class="dv">256</span>),</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>        Antirectifier(),</span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>        layers.Dropout(<span class="fl">0.5</span>),</span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>        layers.Dense(<span class="dv">10</span>),</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>    ]</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>)</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a><span class="co"># Compile the model</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>    loss<span class="op">=</span>keras.losses.SparseCategoricalCrossentropy(from_logits<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>    optimizer<span class="op">=</span>keras.optimizers.RMSprop(),</span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>    metrics<span class="op">=</span>[keras.metrics.SparseCategoricalAccuracy()],</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>)</span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a><span class="co"># Train the model</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>model.fit(</span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>    x_train,</span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>    y_train,</span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>    validation_split<span class="op">=</span><span class="fl">0.15</span>,</span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>)</span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a><span class="co"># Test the model</span></span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>model.evaluate(x_test, y_test)</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tomasz Kalinowski, JJ Allaire, FranÃ§ois Chollet, Posit Software, PBC, Google.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
